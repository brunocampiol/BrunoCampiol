function drawWorld(n,t){for(var r,u,i=n.m_jointList;i;i=i.m_next)drawJoint(i,t);for(r=n.m_bodyList;r;r=r.m_next)for(u=r.GetShapeList();u!=null;u=u.GetNext())drawShape(u,t)}function drawJoint(n,t){var e=n.m_body1,o=n.m_body2,r=e.m_position,u=o.m_position,i=n.GetAnchor1(),f=n.GetAnchor2();t.strokeStyle="#00eeee";t.beginPath();switch(n.m_type){case b2Joint.e_distanceJoint:t.moveTo(i.x,i.y);t.lineTo(f.x,f.y);break;case b2Joint.e_pulleyJoint:break;default:e==world.m_groundBody?(t.moveTo(i.x,i.y),t.lineTo(u.x,u.y)):o==world.m_groundBody?(t.moveTo(i.x,i.y),t.lineTo(r.x,r.y)):(t.moveTo(r.x,r.y),t.lineTo(i.x,i.y),t.lineTo(u.x,u.y),t.lineTo(f.x,f.y))}t.stroke()}function drawShape(n,t){var v,c,l,r,o,u,e;t.strokeStyle="#ffffff";t.beginPath();switch(n.m_type){case b2Shape.e_circleShape:var s=n,i=s.m_position,f=s.m_radius,a=16,h=0,y=2*Math.PI/a;for(t.moveTo(i.x+f,i.y),u=0;u<a;u++)v=new b2Vec2(f*Math.cos(h),f*Math.sin(h)),e=b2Math.AddVV(i,v),t.lineTo(e.x,e.y),h+=y;t.lineTo(i.x+f,i.y);t.moveTo(i.x,i.y);c=s.m_R.col1;l=new b2Vec2(i.x+f*c.x,i.y+f*c.y);t.lineTo(l.x,l.y);break;case b2Shape.e_polyShape:for(r=n,o=b2Math.AddVV(r.m_position,b2Math.b2MulMV(r.m_R,r.m_vertices[0])),t.moveTo(o.x,o.y),u=0;u<r.m_vertexCount;u++)e=b2Math.AddVV(r.m_position,b2Math.b2MulMV(r.m_R,r.m_vertices[u])),t.lineTo(e.x,e.y);t.lineTo(o.x,o.y)}t.stroke()}function createWorld(){var t=new b2AABB;t.minVertex.Set(-1e3,-1e3);t.maxVertex.Set(1e3,1e3);var i=new b2Vec2(0,100),n=new b2World(t,i,!0);return createGround(n),createBox(n,0,500,10,500),createBox(n,800,500,10,500),n}function createGround(n){var i=new b2BoxDef,t;return i.extents.Set(1e5,10),i.restitution=.2,t=new b2BodyDef,t.AddShape(i),t.position.Set(-500,500),n.CreateBody(t)}function createBall(n,t,i,r,u,f){var e=new b2CircleDef,o;return e.density=1,e.radius=r,e.restitution=u,e.friction=f,o=new b2BodyDef,o.AddShape(e),o.position.Set(t,i),n.CreateBody(o)}function createBox(n,t,i,r,u,f){var e,o;return typeof f=="undefined"&&(f=!0),e=new b2BoxDef,f||(e.density=1),e.extents.Set(r,u),o=new b2BodyDef,o.AddShape(e),o.position.Set(t,i),n.CreateBody(o)}function setupWorld(n){n||(n=0);world=createWorld();initId+=n;initId%=demos.InitWorlds.length;initId<0&&(initId=demos.InitWorlds.length+initId);demos.InitWorlds[initId](world)}function setupNextWorld(){setupWorld(1)}function setupPrevWorld(){setupWorld(-1)}function step(n){world.Step(1/60,1);ctx.clearRect(0,0,canvasWidth,canvasHeight);drawWorld(world,ctx);setTimeout("step("+(n||0)+")",10)}function getMousePos(n,t){var i=n.getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top}}function getDropQuantity(){for(var t=document.getElementsByName("dropQuantity"),n=0,i=t.length;n<i;n++)if(t[n].checked)return t[n].value}function getDropType(){for(var t=document.getElementsByName("dropType"),n=0,i=t.length;n<i;n++)if(t[n].checked)return t[n].value}function InitializeBox2D(){var n;setupWorld();ctx=$("canvas").getContext("2d");n=$("canvas");canvasWidth=parseInt(n.width);canvasHeight=parseInt(n.height);canvasTop=parseInt(n.style.top);canvasLeft=parseInt(n.style.left);var u=document.getElementById("canvas"),f=u.getContext("2d"),e=$("canvas").getBoundingClientRect(),t=0,r=0;u.addEventListener("mousemove",function(n){var i=getMousePos(canvas,n);t=i.x;r=i.y},!1);Event.observe("canvas","click",function(){for(i=0;i<getDropQuantity();i++)getDropType()==0?createBall(world,t,r,10,.2,.2):createBox(world,t,r,10,10,!1)});step()}var b2Settings=Class.create(),b2Vec2,b2Mat22,b2Math,b2AABB,b2Bound,b2BoundValues,b2Pair,b2PairCallback,b2BufferedPair,b2PairManager,b2BroadPhase,b2Collision,Features,b2ContactID,b2ContactPoint,b2Distance,b2Manifold,b2OBB,b2Proxy,ClipVertex,b2Shape,b2ShapeDef,b2BoxDef,b2CircleDef,b2CircleShape,b2MassData,b2PolyDef,b2PolyShape,b2Body,b2BodyDef,b2CollisionFilter,b2Island,b2TimeStep,b2ContactNode,b2Contact,b2ContactConstraint,b2ContactConstraintPoint,b2ContactRegister,b2ContactSolver,b2CircleContact,b2Conservative,b2NullContact,b2PolyAndCircleContact,b2PolyContact,b2ContactManager,b2World,b2WorldListener,b2JointNode,b2Joint,b2JointDef,b2DistanceJoint,b2DistanceJointDef,b2Jacobian,b2GearJoint,b2GearJointDef,b2MouseJoint,b2MouseJointDef,b2PrismaticJoint,b2PrismaticJointDef,b2PulleyJoint,b2PulleyJointDef,b2RevoluteJoint,b2RevoluteJointDef,demos,initId,world,ctx,canvasWidth,canvasHeight,canvasTop,canvasLeft;b2Settings.prototype={initialize:function(){}};b2Settings.USHRT_MAX=65535;b2Settings.b2_pi=Math.PI;b2Settings.b2_massUnitsPerKilogram=1;b2Settings.b2_timeUnitsPerSecond=1;b2Settings.b2_lengthUnitsPerMeter=30;b2Settings.b2_maxManifoldPoints=2;b2Settings.b2_maxShapesPerBody=64;b2Settings.b2_maxPolyVertices=8;b2Settings.b2_maxProxies=1024;b2Settings.b2_maxPairs=8*b2Settings.b2_maxProxies;b2Settings.b2_linearSlop=.005*b2Settings.b2_lengthUnitsPerMeter;b2Settings.b2_angularSlop=2/180*b2Settings.b2_pi;b2Settings.b2_velocityThreshold=1*b2Settings.b2_lengthUnitsPerMeter/b2Settings.b2_timeUnitsPerSecond;b2Settings.b2_maxLinearCorrection=.2*b2Settings.b2_lengthUnitsPerMeter;b2Settings.b2_maxAngularCorrection=8/180*b2Settings.b2_pi;b2Settings.b2_contactBaumgarte=.2;b2Settings.b2_timeToSleep=.5*b2Settings.b2_timeUnitsPerSecond;b2Settings.b2_linearSleepTolerance=.01*b2Settings.b2_lengthUnitsPerMeter/b2Settings.b2_timeUnitsPerSecond;b2Settings.b2_angularSleepTolerance=2/180/b2Settings.b2_timeUnitsPerSecond;b2Settings.b2Assert=function(n){if(!n){var t;t.x++}};b2Vec2=Class.create();b2Vec2.prototype={initialize:function(n,t){this.x=n;this.y=t},SetZero:function(){this.x=0;this.y=0},Set:function(n,t){this.x=n;this.y=t},SetV:function(n){this.x=n.x;this.y=n.y},Negative:function(){return new b2Vec2(-this.x,-this.y)},Copy:function(){return new b2Vec2(this.x,this.y)},Add:function(n){this.x+=n.x;this.y+=n.y},Subtract:function(n){this.x-=n.x;this.y-=n.y},Multiply:function(n){this.x*=n;this.y*=n},MulM:function(n){var t=this.x;this.x=n.col1.x*t+n.col2.x*this.y;this.y=n.col1.y*t+n.col2.y*this.y},MulTM:function(n){var t=b2Math.b2Dot(this,n.col1);this.y=b2Math.b2Dot(this,n.col2);this.x=t},CrossVF:function(n){var t=this.x;this.x=n*this.y;this.y=-n*t},CrossFV:function(n){var t=this.x;this.x=-n*this.y;this.y=n*t},MinV:function(n){this.x=this.x<n.x?this.x:n.x;this.y=this.y<n.y?this.y:n.y},MaxV:function(n){this.x=this.x>n.x?this.x:n.x;this.y=this.y>n.y?this.y:n.y},Abs:function(){this.x=Math.abs(this.x);this.y=Math.abs(this.y)},Length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Normalize:function(){var n=this.Length(),t;return n<Number.MIN_VALUE?0:(t=1/n,this.x*=t,this.y*=t,n)},IsValid:function(){return b2Math.b2IsValid(this.x)&&b2Math.b2IsValid(this.y)},x:null,y:null};b2Vec2.Make=function(n,t){return new b2Vec2(n,t)};b2Mat22=Class.create();b2Mat22.prototype={initialize:function(n,t,i){if(n==null&&(n=0),this.col1=new b2Vec2,this.col2=new b2Vec2,t!=null&&i!=null)this.col1.SetV(t),this.col2.SetV(i);else{var r=Math.cos(n),u=Math.sin(n);this.col1.x=r;this.col2.x=-u;this.col1.y=u;this.col2.y=r}},Set:function(n){var t=Math.cos(n),i=Math.sin(n);this.col1.x=t;this.col2.x=-i;this.col1.y=i;this.col2.y=t},SetVV:function(n,t){this.col1.SetV(n);this.col2.SetV(t)},Copy:function(){return new b2Mat22(0,this.col1,this.col2)},SetM:function(n){this.col1.SetV(n.col1);this.col2.SetV(n.col2)},AddM:function(n){this.col1.x+=n.col1.x;this.col1.y+=n.col1.y;this.col2.x+=n.col2.x;this.col2.y+=n.col2.y},SetIdentity:function(){this.col1.x=1;this.col2.x=0;this.col1.y=0;this.col2.y=1},SetZero:function(){this.col1.x=0;this.col2.x=0;this.col1.y=0;this.col2.y=0},Invert:function(n){var i=this.col1.x,r=this.col2.x,u=this.col1.y,f=this.col2.y,t=i*f-r*u;return t=1/t,n.col1.x=t*f,n.col2.x=-t*r,n.col1.y=-t*u,n.col2.y=t*i,n},Solve:function(n,t,i){var u=this.col1.x,f=this.col2.x,e=this.col1.y,o=this.col2.y,r=u*o-f*e;return r=1/r,n.x=r*(o*t-f*i),n.y=r*(u*i-e*t),n},Abs:function(){this.col1.Abs();this.col2.Abs()},col1:new b2Vec2,col2:new b2Vec2};b2Math=Class.create();b2Math.prototype={initialize:function(){}};b2Math.b2IsValid=function(n){return isFinite(n)};b2Math.b2Dot=function(n,t){return n.x*t.x+n.y*t.y};b2Math.b2CrossVV=function(n,t){return n.x*t.y-n.y*t.x};b2Math.b2CrossVF=function(n,t){return new b2Vec2(t*n.y,-t*n.x)};b2Math.b2CrossFV=function(n,t){return new b2Vec2(-n*t.y,n*t.x)};b2Math.b2MulMV=function(n,t){return new b2Vec2(n.col1.x*t.x+n.col2.x*t.y,n.col1.y*t.x+n.col2.y*t.y)};b2Math.b2MulTMV=function(n,t){return new b2Vec2(b2Math.b2Dot(t,n.col1),b2Math.b2Dot(t,n.col2))};b2Math.AddVV=function(n,t){return new b2Vec2(n.x+t.x,n.y+t.y)};b2Math.SubtractVV=function(n,t){return new b2Vec2(n.x-t.x,n.y-t.y)};b2Math.MulFV=function(n,t){return new b2Vec2(n*t.x,n*t.y)};b2Math.AddMM=function(n,t){return new b2Mat22(0,b2Math.AddVV(n.col1,t.col1),b2Math.AddVV(n.col2,t.col2))};b2Math.b2MulMM=function(n,t){return new b2Mat22(0,b2Math.b2MulMV(n,t.col1),b2Math.b2MulMV(n,t.col2))};b2Math.b2MulTMM=function(n,t){var i=new b2Vec2(b2Math.b2Dot(n.col1,t.col1),b2Math.b2Dot(n.col2,t.col1)),r=new b2Vec2(b2Math.b2Dot(n.col1,t.col2),b2Math.b2Dot(n.col2,t.col2));return new b2Mat22(0,i,r)};b2Math.b2Abs=function(n){return n>0?n:-n};b2Math.b2AbsV=function(n){return new b2Vec2(b2Math.b2Abs(n.x),b2Math.b2Abs(n.y))};b2Math.b2AbsM=function(n){return new b2Mat22(0,b2Math.b2AbsV(n.col1),b2Math.b2AbsV(n.col2))};b2Math.b2Min=function(n,t){return n<t?n:t};b2Math.b2MinV=function(n,t){return new b2Vec2(b2Math.b2Min(n.x,t.x),b2Math.b2Min(n.y,t.y))};b2Math.b2Max=function(n,t){return n>t?n:t};b2Math.b2MaxV=function(n,t){return new b2Vec2(b2Math.b2Max(n.x,t.x),b2Math.b2Max(n.y,t.y))};b2Math.b2Clamp=function(n,t,i){return b2Math.b2Max(t,b2Math.b2Min(n,i))};b2Math.b2ClampV=function(n,t,i){return b2Math.b2MaxV(t,b2Math.b2MinV(n,i))};b2Math.b2Swap=function(n,t){var i=n[0];n[0]=t[0];t[0]=i};b2Math.b2Random=function(){return Math.random()*2-1};b2Math.b2NextPowerOfTwo=function(n){return n|=n>>1&2147483647,n|=n>>2&1073741823,n|=n>>4&268435455,n|=n>>8&16777215,n|=n>>16&65535,n+1};b2Math.b2IsPowerOfTwo=function(n){return n>0&&(n&n-1)==0};b2Math.tempVec2=new b2Vec2;b2Math.tempVec3=new b2Vec2;b2Math.tempVec4=new b2Vec2;b2Math.tempVec5=new b2Vec2;b2Math.tempMat=new b2Mat22;b2AABB=Class.create();b2AABB.prototype={IsValid:function(){var n=this.maxVertex.x,t=this.maxVertex.y,i;return n=this.maxVertex.x,t=this.maxVertex.y,n-=this.minVertex.x,t-=this.minVertex.y,i=n>=0&&t>=0,i&&this.minVertex.IsValid()&&this.maxVertex.IsValid()},minVertex:new b2Vec2,maxVertex:new b2Vec2,initialize:function(){this.minVertex=new b2Vec2;this.maxVertex=new b2Vec2}};b2Bound=Class.create();b2Bound.prototype={IsLower:function(){return(this.value&1)==0},IsUpper:function(){return(this.value&1)==1},Swap:function(n){var t=this.value,i=this.proxyId,r=this.stabbingCount;this.value=n.value;this.proxyId=n.proxyId;this.stabbingCount=n.stabbingCount;n.value=t;n.proxyId=i;n.stabbingCount=r},value:0,proxyId:0,stabbingCount:0,initialize:function(){}};b2BoundValues=Class.create();b2BoundValues.prototype={lowerValues:[0,0],upperValues:[0,0],initialize:function(){this.lowerValues=[0,0];this.upperValues=[0,0]}};b2Pair=Class.create();b2Pair.prototype={SetBuffered:function(){this.status|=b2Pair.e_pairBuffered},ClearBuffered:function(){this.status&=~b2Pair.e_pairBuffered},IsBuffered:function(){return(this.status&b2Pair.e_pairBuffered)==b2Pair.e_pairBuffered},SetRemoved:function(){this.status|=b2Pair.e_pairRemoved},ClearRemoved:function(){this.status&=~b2Pair.e_pairRemoved},IsRemoved:function(){return(this.status&b2Pair.e_pairRemoved)==b2Pair.e_pairRemoved},SetFinal:function(){this.status|=b2Pair.e_pairFinal},IsFinal:function(){return(this.status&b2Pair.e_pairFinal)==b2Pair.e_pairFinal},userData:null,proxyId1:0,proxyId2:0,next:0,status:0,initialize:function(){}};b2Pair.b2_nullPair=b2Settings.USHRT_MAX;b2Pair.b2_nullProxy=b2Settings.USHRT_MAX;b2Pair.b2_tableCapacity=b2Settings.b2_maxPairs;b2Pair.b2_tableMask=b2Pair.b2_tableCapacity-1;b2Pair.e_pairBuffered=1;b2Pair.e_pairRemoved=2;b2Pair.e_pairFinal=4;b2PairCallback=Class.create();b2PairCallback.prototype={PairAdded:function(){return null},PairRemoved:function(){},initialize:function(){}};b2BufferedPair=Class.create();b2BufferedPair.prototype={proxyId1:0,proxyId2:0,initialize:function(){}};b2PairManager=Class.create();b2PairManager.prototype={initialize:function(){var n=0;for(this.m_hashTable=new Array(b2Pair.b2_tableCapacity),n=0;n<b2Pair.b2_tableCapacity;++n)this.m_hashTable[n]=b2Pair.b2_nullPair;for(this.m_pairs=new Array(b2Settings.b2_maxPairs),n=0;n<b2Settings.b2_maxPairs;++n)this.m_pairs[n]=new b2Pair;for(this.m_pairBuffer=new Array(b2Settings.b2_maxPairs),n=0;n<b2Settings.b2_maxPairs;++n)this.m_pairBuffer[n]=new b2BufferedPair;for(n=0;n<b2Settings.b2_maxPairs;++n)this.m_pairs[n].proxyId1=b2Pair.b2_nullProxy,this.m_pairs[n].proxyId2=b2Pair.b2_nullProxy,this.m_pairs[n].userData=null,this.m_pairs[n].status=0,this.m_pairs[n].next=n+1;this.m_pairs[b2Settings.b2_maxPairs-1].next=b2Pair.b2_nullPair;this.m_pairCount=0},Initialize:function(n,t){this.m_broadPhase=n;this.m_callback=t},AddBufferedPair:function(n,t){var i=this.AddPair(n,t);i.IsBuffered()==!1&&(i.SetBuffered(),this.m_pairBuffer[this.m_pairBufferCount].proxyId1=i.proxyId1,this.m_pairBuffer[this.m_pairBufferCount].proxyId2=i.proxyId2,++this.m_pairBufferCount);i.ClearRemoved();b2BroadPhase.s_validate&&this.ValidateBuffer()},RemoveBufferedPair:function(n,t){var i=this.Find(n,t);i!=null&&(i.IsBuffered()==!1&&(i.SetBuffered(),this.m_pairBuffer[this.m_pairBufferCount].proxyId1=i.proxyId1,this.m_pairBuffer[this.m_pairBufferCount].proxyId2=i.proxyId2,++this.m_pairBufferCount),i.SetRemoved(),b2BroadPhase.s_validate&&this.ValidateBuffer())},Commit:function(){for(var t=0,i=0,f=this.m_broadPhase.m_proxyPool,n,r,u,t=0;t<this.m_pairBufferCount;++t)n=this.Find(this.m_pairBuffer[t].proxyId1,this.m_pairBuffer[t].proxyId2),n.ClearBuffered(),r=f[n.proxyId1],u=f[n.proxyId2],n.IsRemoved()?(n.IsFinal()==!0&&this.m_callback.PairRemoved(r.userData,u.userData,n.userData),this.m_pairBuffer[i].proxyId1=n.proxyId1,this.m_pairBuffer[i].proxyId2=n.proxyId2,++i):n.IsFinal()==!1&&(n.userData=this.m_callback.PairAdded(r.userData,u.userData),n.SetFinal());for(t=0;t<i;++t)this.RemovePair(this.m_pairBuffer[t].proxyId1,this.m_pairBuffer[t].proxyId2);this.m_pairBufferCount=0;b2BroadPhase.s_validate&&this.ValidateTable()},AddPair:function(n,t){var f,r,i,u;return(n>t&&(f=n,n=t,t=f),r=b2PairManager.Hash(n,t)&b2Pair.b2_tableMask,i=i=this.FindHash(n,t,r),i!=null)?i:(u=this.m_freePair,i=this.m_pairs[u],this.m_freePair=i.next,i.proxyId1=n,i.proxyId2=t,i.status=0,i.userData=null,i.next=this.m_hashTable[r],this.m_hashTable[r]=u,++this.m_pairCount,i)},RemovePair:function(n,t){var e,f,r,s;n>t&&(e=n,n=t,t=e);for(var o=b2PairManager.Hash(n,t)&b2Pair.b2_tableMask,i=this.m_hashTable[o],u=null;i!=b2Pair.b2_nullPair;){if(b2PairManager.Equals(this.m_pairs[i],n,t))return f=i,u?u.next=this.m_pairs[i].next:this.m_hashTable[o]=this.m_pairs[i].next,r=this.m_pairs[f],s=r.userData,r.next=this.m_freePair,r.proxyId1=b2Pair.b2_nullProxy,r.proxyId2=b2Pair.b2_nullProxy,r.userData=null,r.status=0,this.m_freePair=f,--this.m_pairCount,s;u=this.m_pairs[i];i=u.next}return null},Find:function(n,t){var i,r;return n>t&&(i=n,n=t,t=i),r=b2PairManager.Hash(n,t)&b2Pair.b2_tableMask,this.FindHash(n,t,r)},FindHash:function(n,t,i){for(var r=this.m_hashTable[i];r!=b2Pair.b2_nullPair&&b2PairManager.Equals(this.m_pairs[r],n,t)==!1;)r=this.m_pairs[r].next;return r==b2Pair.b2_nullPair?null:this.m_pairs[r]},ValidateBuffer:function(){},ValidateTable:function(){},m_broadPhase:null,m_callback:null,m_pairs:null,m_freePair:0,m_pairCount:0,m_pairBuffer:null,m_pairBufferCount:0,m_hashTable:null};b2PairManager.Hash=function(n,t){var i=t<<16&4294901760|n;return i=~i+(i<<15&4294934528),i=i^i>>12&1048575,i=i+(i<<2&4294967292),i=i^i>>4&268435455,i=i*2057,i^i>>16&65535};b2PairManager.Equals=function(n,t,i){return n.proxyId1==t&&n.proxyId2==i};b2PairManager.EqualsPair=function(n,t){return n.proxyId1==t.proxyId1&&n.proxyId2==t.proxyId2};b2BroadPhase=Class.create();b2BroadPhase.prototype={initialize:function(n,t){var i,u,f,e,r;for(this.m_pairManager=new b2PairManager,this.m_proxyPool=new Array(b2Settings.b2_maxPairs),this.m_bounds=new Array(2*b2Settings.b2_maxProxies),this.m_queryResults=new Array(b2Settings.b2_maxProxies),this.m_quantizationFactor=new b2Vec2,i=0,this.m_pairManager.Initialize(this,t),this.m_worldAABB=n,this.m_proxyCount=0,i=0;i<b2Settings.b2_maxProxies;i++)this.m_queryResults[i]=0;for(this.m_bounds=new Array(2),i=0;i<2;i++)for(this.m_bounds[i]=new Array(2*b2Settings.b2_maxProxies),u=0;u<2*b2Settings.b2_maxProxies;u++)this.m_bounds[i][u]=new b2Bound;for(f=n.maxVertex.x,e=n.maxVertex.y,f-=n.minVertex.x,e-=n.minVertex.y,this.m_quantizationFactor.x=b2Settings.USHRT_MAX/f,this.m_quantizationFactor.y=b2Settings.USHRT_MAX/e,i=0;i<b2Settings.b2_maxProxies-1;++i)r=new b2Proxy,this.m_proxyPool[i]=r,r.SetNext(i+1),r.timeStamp=0,r.overlapCount=b2BroadPhase.b2_invalid,r.userData=null;r=new b2Proxy;this.m_proxyPool[b2Settings.b2_maxProxies-1]=r;r.SetNext(b2Pair.b2_nullProxy);r.timeStamp=0;r.overlapCount=b2BroadPhase.b2_invalid;r.userData=null;this.m_freeProxy=0;this.m_timeStamp=1;this.m_queryResultCount=0},InRange:function(n){var t,i,r,u;return t=n.minVertex.x,i=n.minVertex.y,t-=this.m_worldAABB.maxVertex.x,i-=this.m_worldAABB.maxVertex.y,r=this.m_worldAABB.minVertex.x,u=this.m_worldAABB.minVertex.y,r-=n.maxVertex.x,u-=n.maxVertex.y,t=b2Math.b2Max(t,r),i=b2Math.b2Max(i,u),b2Math.b2Max(t,i)<0},GetProxy:function(n){return n==b2Pair.b2_nullProxy||this.m_proxyPool[n].IsValid()==!1?null:this.m_proxyPool[n]},CreateProxy:function(n,t){var s=0,v,a=this.m_freeProxy,h,y,d,p;v=this.m_proxyPool[a];this.m_freeProxy=v.GetNext();v.overlapCount=0;v.userData=t;var w=2*this.m_proxyCount,b=[],k=[];for(this.ComputeBounds(b,k,n),h=0;h<2;++h){var r=this.m_bounds[h],e=0,o=0,g=[e],nt=[o];this.Query(g,nt,b[h],k[h],r,w,h);e=g[0];o=nt[0];for(var c=[],i=0,l=w-o,u,f,i=0;i<l;i++)c[i]=new b2Bound,u=c[i],f=r[o+i],u.value=f.value,u.proxyId=f.proxyId,u.stabbingCount=f.stabbingCount;for(l=c.length,y=o+2,i=0;i<l;i++)f=c[i],u=r[y+i],u.value=f.value,u.proxyId=f.proxyId,u.stabbingCount=f.stabbingCount;for(c=[],l=o-e,i=0;i<l;i++)c[i]=new b2Bound,u=c[i],f=r[e+i],u.value=f.value,u.proxyId=f.proxyId,u.stabbingCount=f.stabbingCount;for(l=c.length,y=e+1,i=0;i<l;i++)f=c[i],u=r[y+i],u.value=f.value,u.proxyId=f.proxyId,u.stabbingCount=f.stabbingCount;for(++o,r[e].value=b[h],r[e].proxyId=a,r[o].value=k[h],r[o].proxyId=a,r[e].stabbingCount=e==0?0:r[e-1].stabbingCount,r[o].stabbingCount=r[o-1].stabbingCount,s=e;s<o;++s)r[s].stabbingCount++;for(s=e;s<w+2;++s)d=this.m_proxyPool[r[s].proxyId],r[s].IsLower()?d.lowerBounds[h]=s:d.upperBounds[h]=s}for(++this.m_proxyCount,p=0;p<this.m_queryResultCount;++p)this.m_pairManager.AddBufferedPair(a,this.m_queryResults[p]);return this.m_pairManager.Commit(),this.m_queryResultCount=0,this.IncrementTimeStamp(),a},DestroyProxy:function(n){for(var a,h,w,v,y,e=this.m_proxyPool[n],p=2*this.m_proxyCount,s=0;s<2;++s){for(var f=this.m_bounds[s],c=e.lowerBounds[s],l=e.upperBounds[s],b=f[c].value,k=f[l].value,o=[],t=0,u=l-c-1,i,r,t=0;t<u;t++)o[t]=new b2Bound,i=o[t],r=f[c+1+t],i.value=r.value,i.proxyId=r.proxyId,i.stabbingCount=r.stabbingCount;for(u=o.length,a=c,t=0;t<u;t++)r=o[t],i=f[a+t],i.value=r.value,i.proxyId=r.proxyId,i.stabbingCount=r.stabbingCount;for(o=[],u=p-l-1,t=0;t<u;t++)o[t]=new b2Bound,i=o[t],r=f[l+1+t],i.value=r.value,i.proxyId=r.proxyId,i.stabbingCount=r.stabbingCount;for(u=o.length,a=l-1,t=0;t<u;t++)r=o[t],i=f[a+t],i.value=r.value,i.proxyId=r.proxyId,i.stabbingCount=r.stabbingCount;for(u=p-2,h=c;h<u;++h)w=this.m_proxyPool[f[h].proxyId],f[h].IsLower()?w.lowerBounds[s]=h:w.upperBounds[s]=h;for(u=l-1,v=c;v<u;++v)f[v].stabbingCount--;this.Query([0],[0],b,k,f,p-2,s)}for(y=0;y<this.m_queryResultCount;++y)this.m_pairManager.RemoveBufferedPair(n,this.m_queryResults[y]);this.m_pairManager.Commit();this.m_queryResultCount=0;this.IncrementTimeStamp();e.userData=null;e.overlapCount=b2BroadPhase.b2_invalid;e.lowerBounds[0]=b2BroadPhase.b2_invalid;e.lowerBounds[1]=b2BroadPhase.b2_invalid;e.upperBounds[0]=b2BroadPhase.b2_invalid;e.upperBounds[1]=b2BroadPhase.b2_invalid;e.SetNext(this.m_freeProxy);this.m_freeProxy=n;--this.m_proxyCount},MoveProxy:function(n,t){var i=0,r=0,u,e,o,l=0,s,v,y,c;if(n!=b2Pair.b2_nullProxy&&!(b2Settings.b2_maxProxies<=n)&&t.IsValid()!=!1){var d=2*this.m_proxyCount,h=this.m_proxyPool[n],a=new b2BoundValues;for(this.ComputeBounds(a.lowerValues,a.upperValues,t),v=new b2BoundValues,i=0;i<2;++i)v.lowerValues[i]=this.m_bounds[i][h.lowerBounds[i]].value,v.upperValues[i]=this.m_bounds[i][h.upperBounds[i]].value;for(i=0;i<2;++i){var f=this.m_bounds[i],p=h.lowerBounds[i],w=h.upperBounds[i],b=a.lowerValues[i],k=a.upperValues[i],g=b-f[p].value,nt=k-f[w].value;if(f[p].value=b,f[w].value=k,g<0)for(r=p;r>0&&b<f[r-1].value;)u=f[r],e=f[r-1],y=e.proxyId,c=this.m_proxyPool[e.proxyId],e.stabbingCount++,e.IsUpper()==!0?(this.TestOverlap(a,c)&&this.m_pairManager.AddBufferedPair(n,y),c.upperBounds[i]++,u.stabbingCount++):(c.lowerBounds[i]++,u.stabbingCount--),h.lowerBounds[i]--,u.Swap(e),--r;if(nt>0)for(r=w;r<d-1&&f[r+1].value<=k;)u=f[r],o=f[r+1],l=o.proxyId,s=this.m_proxyPool[l],o.stabbingCount++,o.IsLower()==!0?(this.TestOverlap(a,s)&&this.m_pairManager.AddBufferedPair(n,l),s.lowerBounds[i]--,u.stabbingCount++):(s.upperBounds[i]--,u.stabbingCount--),h.upperBounds[i]++,u.Swap(o),r++;if(g>0)for(r=p;r<d-1&&f[r+1].value<=b;)u=f[r],o=f[r+1],l=o.proxyId,s=this.m_proxyPool[l],o.stabbingCount--,o.IsUpper()?(this.TestOverlap(v,s)&&this.m_pairManager.RemoveBufferedPair(n,l),s.upperBounds[i]--,u.stabbingCount--):(s.lowerBounds[i]--,u.stabbingCount++),h.lowerBounds[i]++,u.Swap(o),r++;if(nt<0)for(r=w;r>0&&k<f[r-1].value;)u=f[r],e=f[r-1],y=e.proxyId,c=this.m_proxyPool[y],e.stabbingCount--,e.IsLower()==!0?(this.TestOverlap(v,c)&&this.m_pairManager.RemoveBufferedPair(n,y),c.lowerBounds[i]++,u.stabbingCount--):(c.upperBounds[i]++,u.stabbingCount++),h.upperBounds[i]--,u.Swap(e),r--}}},Commit:function(){this.m_pairManager.Commit()},QueryAABB:function(n,t,i){var f=[],e=[],u,r,h;this.ComputeBounds(f,e,n);var o=[0],s=[0];for(this.Query(o,s,f[0],e[0],this.m_bounds[0],2*this.m_proxyCount,0),this.Query(o,s,f[1],e[1],this.m_bounds[1],2*this.m_proxyCount,1),u=0,r=0;r<this.m_queryResultCount&&u<i;++r,++u)h=this.m_proxyPool[this.m_queryResults[r]],t[r]=h.userData;return this.m_queryResultCount=0,this.IncrementTimeStamp(),u},Validate:function(){for(var n,r,t=0;t<2;++t){var u=this.m_bounds[t],f=2*this.m_proxyCount,i=0;for(n=0;n<f;++n)r=u[n],r.IsLower()==!0?i++:i--}},ComputeBounds:function(n,t,i){var f=i.minVertex.x,e=i.minVertex.y,r,u;f=b2Math.b2Min(f,this.m_worldAABB.maxVertex.x);e=b2Math.b2Min(e,this.m_worldAABB.maxVertex.y);f=b2Math.b2Max(f,this.m_worldAABB.minVertex.x);e=b2Math.b2Max(e,this.m_worldAABB.minVertex.y);r=i.maxVertex.x;u=i.maxVertex.y;r=b2Math.b2Min(r,this.m_worldAABB.maxVertex.x);u=b2Math.b2Min(u,this.m_worldAABB.maxVertex.y);r=b2Math.b2Max(r,this.m_worldAABB.minVertex.x);u=b2Math.b2Max(u,this.m_worldAABB.minVertex.y);n[0]=this.m_quantizationFactor.x*(f-this.m_worldAABB.minVertex.x)&b2Settings.USHRT_MAX-1;t[0]=this.m_quantizationFactor.x*(r-this.m_worldAABB.minVertex.x)&65535|1;n[1]=this.m_quantizationFactor.y*(e-this.m_worldAABB.minVertex.y)&b2Settings.USHRT_MAX-1;t[1]=this.m_quantizationFactor.y*(u-this.m_worldAABB.minVertex.y)&65535|1},TestOverlapValidate:function(n,t){for(var r,i=0;i<2;++i)if((r=this.m_bounds[i],r[n.lowerBounds[i]].value>r[t.upperBounds[i]].value)||r[n.upperBounds[i]].value<r[t.lowerBounds[i]].value)return!1;return!0},TestOverlap:function(n,t){for(var r,i=0;i<2;++i)if((r=this.m_bounds[i],n.lowerValues[i]>r[t.upperBounds[i]].value)||n.upperValues[i]<r[t.lowerBounds[i]].value)return!1;return!0},Query:function(n,t,i,r,u,f,e){for(var o,c,a,s=b2BroadPhase.BinarySearch(u,f,i),l=b2BroadPhase.BinarySearch(u,f,r),h=s;h<l;++h)u[h].IsLower()&&this.IncrementOverlapCount(u[h].proxyId);if(s>0)for(o=s-1,c=u[o].stabbingCount;c;)u[o].IsLower()&&(a=this.m_proxyPool[u[o].proxyId],s<=a.upperBounds[e]&&(this.IncrementOverlapCount(u[o].proxyId),--c)),--o;n[0]=s;t[0]=l},IncrementOverlapCount:function(n){var t=this.m_proxyPool[n];t.timeStamp<this.m_timeStamp?(t.timeStamp=this.m_timeStamp,t.overlapCount=1):(t.overlapCount=2,this.m_queryResults[this.m_queryResultCount]=n,++this.m_queryResultCount)},IncrementTimeStamp:function(){if(this.m_timeStamp==b2Settings.USHRT_MAX){for(var n=0;n<b2Settings.b2_maxProxies;++n)this.m_proxyPool[n].timeStamp=0;this.m_timeStamp=1}else++this.m_timeStamp},m_pairManager:new b2PairManager,m_proxyPool:new Array(b2Settings.b2_maxPairs),m_freeProxy:0,m_bounds:new Array(2*b2Settings.b2_maxProxies),m_queryResults:new Array(b2Settings.b2_maxProxies),m_queryResultCount:0,m_worldAABB:null,m_quantizationFactor:new b2Vec2,m_proxyCount:0,m_timeStamp:0};b2BroadPhase.s_validate=!1;b2BroadPhase.b2_invalid=b2Settings.USHRT_MAX;b2BroadPhase.b2_nullEdge=b2Settings.USHRT_MAX;b2BroadPhase.BinarySearch=function(n,t,i){for(var u=0,f=t-1,r;u<=f;)if(r=Math.floor((u+f)/2),n[r].value>i)f=r-1;else if(n[r].value<i)u=r+1;else return r;return u};b2Collision=Class.create();b2Collision.prototype={initialize:function(){}};b2Collision.b2_nullFeature=255;b2Collision.ClipSegmentToLine=function(n,t,i,r){var u=0,e=t[0].v,c=t[1].v,f=b2Math.b2Dot(i,t[0].v)-r,o=b2Math.b2Dot(i,t[1].v)-r,s,h;return f<=0&&(n[u++]=t[0]),o<=0&&(n[u++]=t[1]),f*o<0&&(s=f/(f-o),h=n[u].v,h.x=e.x+s*(c.x-e.x),h.y=e.y+s*(c.y-e.y),n[u].id=f>0?t[0].id:t[1].id,++u),u};b2Collision.EdgeSeparation=function(n,t,i){var c=n.m_vertices,g=i.m_vertexCount,f=i.m_vertices,l=n.m_normals[t].x,e=n.m_normals[t].y,a=l,r=n.m_R,o,s,u,v,h,y,p,k,d,w,b;for(l=r.col1.x*a+r.col2.x*e,e=r.col1.y*a+r.col2.y*e,o=l,s=e,r=i.m_R,a=o*r.col1.x+s*r.col1.y,s=o*r.col2.x+s*r.col2.y,o=a,u=0,v=Number.MAX_VALUE,h=0;h<g;++h)y=f[h],p=y.x*o+y.y*s,p<v&&(v=p,u=h);return r=n.m_R,k=n.m_position.x+(r.col1.x*c[t].x+r.col2.x*c[t].y),d=n.m_position.y+(r.col1.y*c[t].x+r.col2.y*c[t].y),r=i.m_R,w=i.m_position.x+(r.col1.x*f[u].x+r.col2.x*f[u].y),b=i.m_position.y+(r.col1.y*f[u].x+r.col2.y*f[u].y),w-=k,b-=d,w*l+b*e};b2Collision.FindMaxSeparation=function(n,t,i,r){for(var v,u,y,o,p,s,e,l,a,h=t.m_vertexCount,w=i.m_position.x-t.m_position.x,b=i.m_position.y-t.m_position.y,d=w*t.m_R.col1.x+b*t.m_R.col1.y,g=w*t.m_R.col2.x+b*t.m_R.col2.y,f=0,k=-Number.MAX_VALUE,c=0;c<h;++c)v=t.m_normals[c].x*d+t.m_normals[c].y*g,v>k&&(k=v,f=c);if(u=b2Collision.EdgeSeparation(t,f,i),u>0&&r==!1)return u;if(y=f-1>=0?f-1:h-1,o=b2Collision.EdgeSeparation(t,y,i),o>0&&r==!1)return o;if(p=f+1<h?f+1:0,s=b2Collision.EdgeSeparation(t,p,i),s>0&&r==!1)return s;if(e=0,a=0,o>u&&o>s)a=-1,e=y,l=o;else if(s>u)a=1,e=p,l=s;else return n[0]=f,u;for(;;){if(f=a==-1?e-1>=0?e-1:h-1:e+1<h?e+1:0,u=b2Collision.EdgeSeparation(t,f,i),u>0&&r==!1)return u;if(u>l)e=f,l=u;else break}return n[0]=e,l};b2Collision.FindIncidentEdge=function(n,t,i,r){var et=t.m_vertexCount,rt=t.m_vertices,ut=r.m_vertexCount,k=r.m_vertices,ot=i,st=i+1==et?0:i+1,u=rt[st],c=u.x,l=u.y,o,a,d,y,f,p,w,v,nt,tt,s,h,it,e;u=rt[ot];c-=u.x;l-=u.y;o=c;c=l;l=-o;a=1/Math.sqrt(c*c+l*l);c*=a;l*=a;d=c;y=l;o=d;f=t.m_R;d=f.col1.x*o+f.col2.x*y;y=f.col1.y*o+f.col2.y*y;p=d;w=y;f=r.m_R;o=p*f.col1.x+w*f.col1.y;w=p*f.col2.x+w*f.col2.y;p=o;var b=0,g=0,ft=Number.MAX_VALUE;for(v=0;v<ut;++v)nt=v,tt=v+1<ut?v+1:0,u=k[tt],s=u.x,h=u.y,u=k[nt],s-=u.x,h-=u.y,o=s,s=h,h=-o,a=1/Math.sqrt(s*s+h*h),s*=a,h*=a,it=s*p+h*w,it<ft&&(ft=it,b=nt,g=tt);e=n[0];u=e.v;u.SetV(k[b]);u.MulM(r.m_R);u.Add(r.m_position);e.id.features.referenceFace=i;e.id.features.incidentEdge=b;e.id.features.incidentVertex=b;e=n[1];u=e.v;u.SetV(k[g]);u.MulM(r.m_R);u.Add(r.m_position);e.id.features.referenceFace=i;e.id.features.incidentEdge=b;e.id.features.incidentVertex=g};b2Collision.b2CollidePolyTempVec=new b2Vec2;b2Collision.b2CollidePoly=function(n,t,i,r){var et,st,h,c,p,l,k,w,it,b,ht,ct,d;n.pointCount=0;var rt=0,lt=[rt],at=b2Collision.FindMaxSeparation(lt,t,i,r);if(rt=lt[0],!(at>0)||r!=!1){var ut=0,vt=[ut],yt=b2Collision.FindMaxSeparation(vt,i,t,r);if(ut=vt[0],!(yt>0)||r!=!1){var f,ft,a=0,g=0;yt>.98*at+.001?(f=i,ft=t,a=ut,g=1):(f=t,ft=i,a=rt,g=0);et=[new ClipVertex,new ClipVertex];b2Collision.FindIncidentEdge(et,f,a,ft);var wt=f.m_vertexCount,ot=f.m_vertices,v=ot[a],y=a+1<wt?ot[a+1]:ot[0],gt=y.x-v.x,ni=y.y-v.y,o=y.x-v.x,e=y.y-v.y,s=o,u=f.m_R;o=u.col1.x*s+u.col2.x*e;e=u.col1.y*s+u.col2.y*e;st=1/Math.sqrt(o*o+e*e);o*=st;e*=st;h=o;c=e;s=h;h=c;c=-s;p=v.x;l=v.y;s=p;u=f.m_R;p=u.col1.x*s+u.col2.x*l;l=u.col1.y*s+u.col2.y*l;p+=f.m_position.x;l+=f.m_position.y;k=y.x;w=y.y;s=k;u=f.m_R;k=u.col1.x*s+u.col2.x*w;w=u.col1.y*s+u.col2.y*w;k+=f.m_position.x;w+=f.m_position.y;var bt=h*p+c*l,kt=-(o*p+e*l),dt=o*k+e*w,pt=[new ClipVertex,new ClipVertex],nt=[new ClipVertex,new ClipVertex],tt=0;if((b2Collision.b2CollidePolyTempVec.Set(-o,-e),tt=b2Collision.ClipSegmentToLine(pt,et,b2Collision.b2CollidePolyTempVec,kt),!(tt<2))&&(b2Collision.b2CollidePolyTempVec.Set(o,e),tt=b2Collision.ClipSegmentToLine(nt,pt,b2Collision.b2CollidePolyTempVec,dt),!(tt<2))){for(g?n.normal.Set(-h,-c):n.normal.Set(h,c),it=0,b=0;b<b2Settings.b2_maxManifoldPoints;++b)ht=nt[b].v,ct=h*ht.x+c*ht.y-bt,(ct<=0||r==!0)&&(d=n.points[it],d.separation=ct,d.position.SetV(nt[b].v),d.id.Set(nt[b].id),d.id.features.flip=g,++it);n.pointCount=it}}}};b2Collision.b2CollideCircle=function(n,t,i,r){var h,c,l,u;n.pointCount=0;var e=i.m_position.x-t.m_position.x,o=i.m_position.y-t.m_position.y,s=e*e+o*o,f=t.m_radius+i.m_radius;s>f*f&&r==!1||(s<Number.MIN_VALUE?(h=-f,n.normal.Set(0,1)):(c=Math.sqrt(s),h=c-f,l=1/c,n.normal.x=l*e,n.normal.y=l*o),n.pointCount=1,u=n.points[0],u.id.set_key(0),u.separation=h,u.position.x=i.m_position.x-i.m_radius*n.normal.x,u.position.y=i.m_position.y-i.m_radius*n.normal.y)};b2Collision.b2CollidePolyAndCircle=function(n,t,i){var c,g,v,b,tt,it;n.pointCount=0;var r,e,o,l=i.m_position.x-t.m_position.x,a=i.m_position.y-t.m_position.y,u=t.m_R,rt=l*u.col1.x+a*u.col1.y;a=l*u.col2.x+a*u.col2.y;l=rt;var h,k=0,d=-Number.MAX_VALUE,s=i.m_radius;for(c=0;c<t.m_vertexCount;++c){if(g=t.m_normals[c].x*(l-t.m_vertices[c].x)+t.m_normals[c].y*(a-t.m_vertices[c].y),g>s)return;g>d&&(d=g,k=c)}if(d<Number.MIN_VALUE){n.pointCount=1;v=t.m_normals[k];n.normal.x=u.col1.x*v.x+u.col2.x*v.y;n.normal.y=u.col1.y*v.x+u.col2.y*v.y;r=n.points[0];r.id.features.incidentEdge=k;r.id.features.incidentVertex=b2Collision.b2_nullFeature;r.id.features.referenceFace=b2Collision.b2_nullFeature;r.id.features.flip=0;r.position.x=i.m_position.x-s*n.normal.x;r.position.y=i.m_position.y-s*n.normal.y;r.separation=d-s;return}var f=k,y=f+1<t.m_vertexCount?f+1:0,p=t.m_vertices[y].x-t.m_vertices[f].x,w=t.m_vertices[y].y-t.m_vertices[f].y,nt=Math.sqrt(p*p+w*w);if(p/=nt,w/=nt,nt<Number.MIN_VALUE){if(e=l-t.m_vertices[f].x,o=a-t.m_vertices[f].y,h=Math.sqrt(e*e+o*o),e/=h,o/=h,h>s)return;n.pointCount=1;n.normal.Set(u.col1.x*e+u.col2.x*o,u.col1.y*e+u.col2.y*o);r=n.points[0];r.id.features.incidentEdge=b2Collision.b2_nullFeature;r.id.features.incidentVertex=f;r.id.features.referenceFace=b2Collision.b2_nullFeature;r.id.features.flip=0;r.position.x=i.m_position.x-s*n.normal.x;r.position.y=i.m_position.y-s*n.normal.y;r.separation=h-s;return}(b=(l-t.m_vertices[f].x)*p+(a-t.m_vertices[f].y)*w,r=n.points[0],r.id.features.incidentEdge=b2Collision.b2_nullFeature,r.id.features.incidentVertex=b2Collision.b2_nullFeature,r.id.features.referenceFace=b2Collision.b2_nullFeature,r.id.features.flip=0,b<=0?(tt=t.m_vertices[f].x,it=t.m_vertices[f].y,r.id.features.incidentVertex=f):b>=nt?(tt=t.m_vertices[y].x,it=t.m_vertices[y].y,r.id.features.incidentVertex=y):(tt=p*b+t.m_vertices[f].x,it=w*b+t.m_vertices[f].y,r.id.features.incidentEdge=f),e=l-tt,o=a-it,h=Math.sqrt(e*e+o*o),e/=h,o/=h,h>s)||(n.pointCount=1,n.normal.Set(u.col1.x*e+u.col2.x*o,u.col1.y*e+u.col2.y*o),r.position.x=i.m_position.x-s*n.normal.x,r.position.y=i.m_position.y-s*n.normal.y,r.separation=h-s)};b2Collision.b2TestOverlap=function(n,t){var i=t.minVertex,r=n.maxVertex,e=i.x-r.x,o=i.y-r.y,u,f;return(i=n.minVertex,r=t.maxVertex,u=i.x-r.x,f=i.y-r.y,e>0||o>0)?!1:u>0||f>0?!1:!0};Features=Class.create();Features.prototype={set_referenceFace:function(n){this._referenceFace=n;this._m_id._key=this._m_id._key&4294967040|this._referenceFace&255},get_referenceFace:function(){return this._referenceFace},_referenceFace:0,set_incidentEdge:function(n){this._incidentEdge=n;this._m_id._key=this._m_id._key&4294902015|this._incidentEdge<<8&65280},get_incidentEdge:function(){return this._incidentEdge},_incidentEdge:0,set_incidentVertex:function(n){this._incidentVertex=n;this._m_id._key=this._m_id._key&4278255615|this._incidentVertex<<16&16711680},get_incidentVertex:function(){return this._incidentVertex},_incidentVertex:0,set_flip:function(n){this._flip=n;this._m_id._key=this._m_id._key&16777215|this._flip<<24&4278190080},get_flip:function(){return this._flip},_flip:0,_m_id:null,initialize:function(){}};b2ContactID=Class.create();b2ContactID.prototype={initialize:function(){this.features=new Features;this.features._m_id=this},Set:function(n){this.set_key(n._key)},Copy:function(){var n=new b2ContactID;return n.set_key(this._key),n},get_key:function(){return this._key},set_key:function(n){this._key=n;this.features._referenceFace=this._key&255;this.features._incidentEdge=(this._key&65280)>>8&255;this.features._incidentVertex=(this._key&16711680)>>16&255;this.features._flip=(this._key&4278190080)>>24&255},features:new Features,_key:0};b2ContactPoint=Class.create();b2ContactPoint.prototype={position:new b2Vec2,separation:null,normalImpulse:null,tangentImpulse:null,id:new b2ContactID,initialize:function(){this.position=new b2Vec2;this.id=new b2ContactID}};b2Distance=Class.create();b2Distance.prototype={initialize:function(){}};b2Distance.ProcessTwo=function(n,t,i,r,u){var h=-u[1].x,c=-u[1].y,e=u[0].x-u[1].x,o=u[0].y-u[1].y,s=Math.sqrt(e*e+o*o),f;return(e/=s,o/=s,f=h*e+c*o,f<=0||s<Number.MIN_VALUE)?(n.SetV(i[1]),t.SetV(r[1]),i[0].SetV(i[1]),r[0].SetV(r[1]),u[0].SetV(u[1]),1):(f/=s,n.x=i[1].x+f*(i[0].x-i[1].x),n.y=i[1].y+f*(i[0].y-i[1].y),t.x=r[1].x+f*(r[0].x-r[1].x),t.y=r[1].y+f*(r[0].y-r[1].y),2)};b2Distance.ProcessThree=function(n,t,i,r,u){var e=u[0].x,o=u[0].y,s=u[1].x,h=u[1].y,c=u[2].x,l=u[2].y,b=s-e,k=h-o,d=c-e,g=l-o,et=c-s,ot=l-h,ht=-(e*b+o*k),ct=s*b+h*k,nt=-(e*d+o*g),tt=c*d+l*g,it=-(s*et+h*ot),rt=c*et+l*ot,p,f,a;if(tt<=0&&rt<=0)return n.SetV(i[2]),t.SetV(r[2]),i[0].SetV(i[2]),r[0].SetV(r[2]),u[0].SetV(u[2]),1;var ut=b*g-k*d,st=ut*(e*h-o*s),ft=ut*(s*l-h*c);if(ft<=0&&it>=0&&rt>=0)return f=it/(it+rt),n.x=i[1].x+f*(i[2].x-i[1].x),n.y=i[1].y+f*(i[2].y-i[1].y),t.x=r[1].x+f*(r[2].x-r[1].x),t.y=r[1].y+f*(r[2].y-r[1].y),i[0].SetV(i[2]),r[0].SetV(r[2]),u[0].SetV(u[2]),2;if(p=ut*(c*o-l*e),p<=0&&nt>=0&&tt>=0)return f=nt/(nt+tt),n.x=i[0].x+f*(i[2].x-i[0].x),n.y=i[0].y+f*(i[2].y-i[0].y),t.x=r[0].x+f*(r[2].x-r[0].x),t.y=r[0].y+f*(r[2].y-r[0].y),i[1].SetV(i[2]),r[1].SetV(r[2]),u[1].SetV(u[2]),2;a=ft+p+st;a=1/a;var v=ft*a,y=p*a,w=1-v-y;return n.x=v*i[0].x+y*i[1].x+w*i[2].x,n.y=v*i[0].y+y*i[1].y+w*i[2].y,t.x=v*r[0].x+y*r[1].x+w*r[2].x,t.y=v*r[0].y+y*r[1].y+w*r[2].y,3};b2Distance.InPoinsts=function(n,t,i){for(var r=0;r<i;++r)if(n.x==t[r].x&&n.y==t[r].y)return!0;return!1};b2Distance.Distance=function(n,t,i,r){var s=new Array(3),h=new Array(3),u=new Array(3),f=0,e,d,c,k,o;for(n.SetV(i.m_position),t.SetV(r.m_position),e=0,d=20,c=0;c<d;++c){var l=t.x-n.x,a=t.y-n.y,v=i.Support(l,a),y=r.Support(-l,-a);e=l*l+a*a;var p=y.x-v.x,b=y.y-v.y,g=l*p+a*b;if(e-b2Dot(l*p+a*b)<=.01*e)return f==0&&(n.SetV(v),t.SetV(y)),b2Distance.g_GJK_Iterations=c,Math.sqrt(e);switch(f){case 0:s[0].SetV(v);h[0].SetV(y);u[0]=w;n.SetV(s[0]);t.SetV(h[0]);++f;break;case 1:s[1].SetV(v);h[1].SetV(y);u[1].x=p;u[1].y=b;f=b2Distance.ProcessTwo(n,t,s,h,u);break;case 2:s[2].SetV(v);h[2].SetV(y);u[2].x=p;u[2].y=b;f=b2Distance.ProcessThree(n,t,s,h,u)}if(f==3)return b2Distance.g_GJK_Iterations=c,0;for(k=-Number.MAX_VALUE,o=0;o<f;++o)k=b2Math.b2Max(k,u[o].x*u[o].x+u[o].y*u[o].y);if(f==3||e<=100*Number.MIN_VALUE*k)return b2Distance.g_GJK_Iterations=c,Math.sqrt(e)}return b2Distance.g_GJK_Iterations=d,Math.sqrt(e)};b2Distance.g_GJK_Iterations=0;b2Manifold=Class.create();b2Manifold.prototype={initialize:function(){this.points=new Array(b2Settings.b2_maxManifoldPoints);for(var n=0;n<b2Settings.b2_maxManifoldPoints;n++)this.points[n]=new b2ContactPoint;this.normal=new b2Vec2},points:null,normal:null,pointCount:0};b2OBB=Class.create();b2OBB.prototype={R:new b2Mat22,center:new b2Vec2,extents:new b2Vec2,initialize:function(){this.R=new b2Mat22;this.center=new b2Vec2;this.extents=new b2Vec2}};b2Proxy=Class.create();b2Proxy.prototype={GetNext:function(){return this.lowerBounds[0]},SetNext:function(n){this.lowerBounds[0]=n},IsValid:function(){return this.overlapCount!=b2BroadPhase.b2_invalid},lowerBounds:[0,0],upperBounds:[0,0],overlapCount:0,timeStamp:0,userData:null,initialize:function(){this.lowerBounds=[0,0];this.upperBounds=[0,0]}};ClipVertex=Class.create();ClipVertex.prototype={v:new b2Vec2,id:new b2ContactID,initialize:function(){this.v=new b2Vec2;this.id=new b2ContactID}};b2Shape=Class.create();b2Shape.prototype={TestPoint:function(){return!1},GetUserData:function(){return this.m_userData},GetType:function(){return this.m_type},GetBody:function(){return this.m_body},GetPosition:function(){return this.m_position},GetRotationMatrix:function(){return this.m_R},ResetProxy:function(){},GetNext:function(){return this.m_next},initialize:function(n,t){this.m_R=new b2Mat22;this.m_position=new b2Vec2;this.m_userData=n.userData;this.m_friction=n.friction;this.m_restitution=n.restitution;this.m_body=t;this.m_proxyId=b2Pair.b2_nullProxy;this.m_maxRadius=0;this.m_categoryBits=n.categoryBits;this.m_maskBits=n.maskBits;this.m_groupIndex=n.groupIndex},DestroyProxy:function(){this.m_proxyId!=b2Pair.b2_nullProxy&&(this.m_body.m_world.m_broadPhase.DestroyProxy(this.m_proxyId),this.m_proxyId=b2Pair.b2_nullProxy)},Synchronize:function(){},QuickSync:function(){},Support:function(){},GetMaxRadius:function(){return this.m_maxRadius},m_next:null,m_R:new b2Mat22,m_position:new b2Vec2,m_type:0,m_userData:null,m_body:null,m_friction:null,m_restitution:null,m_maxRadius:null,m_proxyId:0,m_categoryBits:0,m_maskBits:0,m_groupIndex:0};b2Shape.Create=function(n,t,i){switch(n.type){case b2Shape.e_circleShape:return new b2CircleShape(n,t,i);case b2Shape.e_boxShape:case b2Shape.e_polyShape:return new b2PolyShape(n,t,i)}return null};b2Shape.Destroy=function(n){n.m_proxyId!=b2Pair.b2_nullProxy&&n.m_body.m_world.m_broadPhase.DestroyProxy(n.m_proxyId)};b2Shape.e_unknownShape=-1;b2Shape.e_circleShape=0;b2Shape.e_boxShape=1;b2Shape.e_polyShape=2;b2Shape.e_meshShape=3;b2Shape.e_shapeTypeCount=4;b2Shape.PolyMass=function(n,t,i,r){var u=new b2Vec2,f,e;u.SetZero();var s=0,h=0,it=new b2Vec2(0,0),w=1/3;for(f=0;f<i;++f){var o=it,d=t[f],g=f+1<i?t[f+1]:t[0],b=b2Math.SubtractVV(d,o),k=b2Math.SubtractVV(g,o),nt=b2Math.b2CrossVV(b,k),tt=.5*nt;s+=tt;e=new b2Vec2;e.SetV(o);e.Add(d);e.Add(g);e.Multiply(w*tt);u.Add(e);var c=o.x,l=o.y,a=b.x,v=b.y,y=k.x,p=k.y,rt=w*(.25*(a*a+y*a+y*y)+(c*a+c*y))+.5*c*c,ut=w*(.25*(v*v+p*v+p*p)+(l*v+l*p))+.5*l*l;h+=nt*(rt+ut)}n.mass=r*s;u.Multiply(1/s);n.center=u;h=r*(h-s*b2Math.b2Dot(u,u));n.I=h};b2Shape.PolyCentroid=function(n,t,i){for(var u=0,f=0,e=0,c=1/3,r=0;r<t;++r){var o=0,s=0,l=n[r].x,a=n[r].y,v=r+1<t?n[r+1].x:n[0].x,y=r+1<t?n[r+1].y:n[0].y,p=l-o,w=a-s,b=v-o,k=y-s,d=p*k-w*b,h=.5*d;e+=h;u+=h*c*(o+l+v);f+=h*c*(s+a+y)}u*=1/e;f*=1/e;i.Set(u,f)};b2ShapeDef=Class.create();b2ShapeDef.prototype={initialize:function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=.2;this.restitution=0;this.density=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0},ComputeMass:function(n){var t,i,r;n.center=new b2Vec2(0,0);this.density==0&&(n.mass=0,n.center.Set(0,0),n.I=0);switch(this.type){case b2Shape.e_circleShape:t=this;n.mass=this.density*b2Settings.b2_pi*t.radius*t.radius;n.center.Set(0,0);n.I=.5*n.mass*t.radius*t.radius;break;case b2Shape.e_boxShape:i=this;n.mass=4*this.density*i.extents.x*i.extents.y;n.center.Set(0,0);n.I=n.mass/3*b2Math.b2Dot(i.extents,i.extents);break;case b2Shape.e_polyShape:r=this;b2Shape.PolyMass(n,r.vertices,r.vertexCount,this.density);break;default:n.mass=0;n.center.Set(0,0);n.I=0}},type:0,userData:null,localPosition:null,localRotation:null,friction:null,restitution:null,density:null,categoryBits:0,maskBits:0,groupIndex:0};b2BoxDef=Class.create();Object.extend(b2BoxDef.prototype,b2ShapeDef.prototype);Object.extend(b2BoxDef.prototype,{initialize:function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=.2;this.restitution=0;this.density=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0;this.type=b2Shape.e_boxShape;this.extents=new b2Vec2(1,1)},extents:null});b2CircleDef=Class.create();Object.extend(b2CircleDef.prototype,b2ShapeDef.prototype);Object.extend(b2CircleDef.prototype,{initialize:function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=.2;this.restitution=0;this.density=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0;this.type=b2Shape.e_circleShape;this.radius=1},radius:null});b2CircleShape=Class.create();Object.extend(b2CircleShape.prototype,b2Shape.prototype);Object.extend(b2CircleShape.prototype,{TestPoint:function(n){var t=new b2Vec2;return t.SetV(n),t.Subtract(this.m_position),b2Math.b2Dot(t,t)<=this.m_radius*this.m_radius},initialize:function(n,t,i){var o,u,f,r,e;this.m_R=new b2Mat22;this.m_position=new b2Vec2;this.m_userData=n.userData;this.m_friction=n.friction;this.m_restitution=n.restitution;this.m_body=t;this.m_proxyId=b2Pair.b2_nullProxy;this.m_maxRadius=0;this.m_categoryBits=n.categoryBits;this.m_maskBits=n.maskBits;this.m_groupIndex=n.groupIndex;this.m_localPosition=new b2Vec2;o=n;this.m_localPosition.Set(n.localPosition.x-i.x,n.localPosition.y-i.y);this.m_type=b2Shape.e_circleShape;this.m_radius=o.radius;this.m_R.SetM(this.m_body.m_R);u=this.m_R.col1.x*this.m_localPosition.x+this.m_R.col2.x*this.m_localPosition.y;f=this.m_R.col1.y*this.m_localPosition.x+this.m_R.col2.y*this.m_localPosition.y;this.m_position.x=this.m_body.m_position.x+u;this.m_position.y=this.m_body.m_position.y+f;this.m_maxRadius=Math.sqrt(u*u+f*f)+this.m_radius;r=new b2AABB;r.minVertex.Set(this.m_position.x-this.m_radius,this.m_position.y-this.m_radius);r.maxVertex.Set(this.m_position.x+this.m_radius,this.m_position.y+this.m_radius);e=this.m_body.m_world.m_broadPhase;this.m_proxyId=e.InRange(r)?e.CreateProxy(r,this):b2Pair.b2_nullProxy;this.m_proxyId==b2Pair.b2_nullProxy&&this.m_body.Freeze()},Synchronize:function(n,t,i,r){var f;if(this.m_R.SetM(r),this.m_position.x=r.col1.x*this.m_localPosition.x+r.col2.x*this.m_localPosition.y+i.x,this.m_position.y=r.col1.y*this.m_localPosition.x+r.col2.y*this.m_localPosition.y+i.y,this.m_proxyId!=b2Pair.b2_nullProxy){var e=n.x+(t.col1.x*this.m_localPosition.x+t.col2.x*this.m_localPosition.y),o=n.y+(t.col1.y*this.m_localPosition.x+t.col2.y*this.m_localPosition.y),s=Math.min(e,this.m_position.x),h=Math.min(o,this.m_position.y),c=Math.max(e,this.m_position.x),l=Math.max(o,this.m_position.y),u=new b2AABB;u.minVertex.Set(s-this.m_radius,h-this.m_radius);u.maxVertex.Set(c+this.m_radius,l+this.m_radius);f=this.m_body.m_world.m_broadPhase;f.InRange(u)?f.MoveProxy(this.m_proxyId,u):this.m_body.Freeze()}},QuickSync:function(n,t){this.m_R.SetM(t);this.m_position.x=t.col1.x*this.m_localPosition.x+t.col2.x*this.m_localPosition.y+n.x;this.m_position.y=t.col1.y*this.m_localPosition.x+t.col2.y*this.m_localPosition.y+n.y},ResetProxy:function(n){var i,t;this.m_proxyId!=b2Pair.b2_nullProxy&&(i=n.GetProxy(this.m_proxyId),n.DestroyProxy(this.m_proxyId),i=null,t=new b2AABB,t.minVertex.Set(this.m_position.x-this.m_radius,this.m_position.y-this.m_radius),t.maxVertex.Set(this.m_position.x+this.m_radius,this.m_position.y+this.m_radius),this.m_proxyId=n.InRange(t)?n.CreateProxy(t,this):b2Pair.b2_nullProxy,this.m_proxyId==b2Pair.b2_nullProxy&&this.m_body.Freeze())},Support:function(n,t,i){var r=Math.sqrt(n*n+t*t);n/=r;t/=r;i.Set(this.m_position.x+this.m_radius*n,this.m_position.y+this.m_radius*t)},m_localPosition:new b2Vec2,m_radius:null});b2MassData=Class.create();b2MassData.prototype={mass:0,center:new b2Vec2(0,0),I:0,initialize:function(){this.center=new b2Vec2(0,0)}};b2PolyDef=Class.create();Object.extend(b2PolyDef.prototype,b2ShapeDef.prototype);Object.extend(b2PolyDef.prototype,{initialize:function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=.2;this.restitution=0;this.density=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0;this.vertices=new Array(b2Settings.b2_maxPolyVertices);this.type=b2Shape.e_polyShape;this.vertexCount=0;for(var n=0;n<b2Settings.b2_maxPolyVertices;n++)this.vertices[n]=new b2Vec2},vertices:new Array(b2Settings.b2_maxPolyVertices),vertexCount:0});b2PolyShape=Class.create();Object.extend(b2PolyShape.prototype,b2Shape.prototype);Object.extend(b2PolyShape.prototype,{TestPoint:function(n){var i=new b2Vec2,t,r,u;for(i.SetV(n),i.Subtract(this.m_position),i.MulTM(this.m_R),t=0;t<this.m_vertexCount;++t)if(r=new b2Vec2,r.SetV(i),r.Subtract(this.m_vertices[t]),u=b2Math.b2Dot(this.m_normals[t],r),u>0)return!1;return!0},initialize:function(n,t,i){var u,e,o,f,c,r,it,s,h,l,p,w,a,v,y,ut,ft,et;if(this.m_R=new b2Mat22,this.m_position=new b2Vec2,this.m_userData=n.userData,this.m_friction=n.friction,this.m_restitution=n.restitution,this.m_body=t,this.m_proxyId=b2Pair.b2_nullProxy,this.m_maxRadius=0,this.m_categoryBits=n.categoryBits,this.m_maskBits=n.maskBits,this.m_groupIndex=n.groupIndex,this.syncAABB=new b2AABB,this.syncMat=new b2Mat22,this.m_localCentroid=new b2Vec2,this.m_localOBB=new b2OBB,u=0,c=new b2AABB,this.m_vertices=new Array(b2Settings.b2_maxPolyVertices),this.m_coreVertices=new Array(b2Settings.b2_maxPolyVertices),this.m_normals=new Array(b2Settings.b2_maxPolyVertices),this.m_type=b2Shape.e_polyShape,r=new b2Mat22(n.localRotation),n.type==b2Shape.e_boxShape)this.m_localCentroid.x=n.localPosition.x-i.x,this.m_localCentroid.y=n.localPosition.y-i.y,it=n,this.m_vertexCount=4,e=it.extents.x,o=it.extents.y,s=Math.max(0,e-2*b2Settings.b2_linearSlop),h=Math.max(0,o-2*b2Settings.b2_linearSlop),f=this.m_vertices[0]=new b2Vec2,f.x=r.col1.x*e+r.col2.x*o,f.y=r.col1.y*e+r.col2.y*o,f=this.m_vertices[1]=new b2Vec2,f.x=r.col1.x*-e+r.col2.x*o,f.y=r.col1.y*-e+r.col2.y*o,f=this.m_vertices[2]=new b2Vec2,f.x=r.col1.x*-e+r.col2.x*-o,f.y=r.col1.y*-e+r.col2.y*-o,f=this.m_vertices[3]=new b2Vec2,f.x=r.col1.x*e+r.col2.x*-o,f.y=r.col1.y*e+r.col2.y*-o,f=this.m_coreVertices[0]=new b2Vec2,f.x=r.col1.x*s+r.col2.x*h,f.y=r.col1.y*s+r.col2.y*h,f=this.m_coreVertices[1]=new b2Vec2,f.x=r.col1.x*-s+r.col2.x*h,f.y=r.col1.y*-s+r.col2.y*h,f=this.m_coreVertices[2]=new b2Vec2,f.x=r.col1.x*-s+r.col2.x*-h,f.y=r.col1.y*-s+r.col2.y*-h,f=this.m_coreVertices[3]=new b2Vec2,f.x=r.col1.x*s+r.col2.x*-h,f.y=r.col1.y*s+r.col2.y*-h;else for(l=n,this.m_vertexCount=l.vertexCount,b2Shape.PolyCentroid(l.vertices,l.vertexCount,b2PolyShape.tempVec),p=b2PolyShape.tempVec.x,w=b2PolyShape.tempVec.y,this.m_localCentroid.x=n.localPosition.x+(r.col1.x*p+r.col2.x*w)-i.x,this.m_localCentroid.y=n.localPosition.y+(r.col1.y*p+r.col2.y*w)-i.y,u=0;u<this.m_vertexCount;++u){this.m_vertices[u]=new b2Vec2;this.m_coreVertices[u]=new b2Vec2;e=l.vertices[u].x-p;o=l.vertices[u].y-w;this.m_vertices[u].x=r.col1.x*e+r.col2.x*o;this.m_vertices[u].y=r.col1.y*e+r.col2.y*o;var b=this.m_vertices[u].x,k=this.m_vertices[u].y,rt=Math.sqrt(b*b+k*k);rt>Number.MIN_VALUE&&(b*=1/rt,k*=1/rt);this.m_coreVertices[u].x=this.m_vertices[u].x-2*b2Settings.b2_linearSlop*b;this.m_coreVertices[u].y=this.m_vertices[u].y-2*b2Settings.b2_linearSlop*k}var d=Number.MAX_VALUE,g=Number.MAX_VALUE,nt=-Number.MAX_VALUE,tt=-Number.MAX_VALUE;for(this.m_maxRadius=0,u=0;u<this.m_vertexCount;++u)a=this.m_vertices[u],d=Math.min(d,a.x),g=Math.min(g,a.y),nt=Math.max(nt,a.x),tt=Math.max(tt,a.y),this.m_maxRadius=Math.max(this.m_maxRadius,a.Length());for(this.m_localOBB.R.SetIdentity(),this.m_localOBB.center.Set((d+nt)*.5,(g+tt)*.5),this.m_localOBB.extents.Set((nt-d)*.5,(tt-g)*.5),v=0,y=0,u=0;u<this.m_vertexCount;++u)this.m_normals[u]=new b2Vec2,v=u,y=u+1<this.m_vertexCount?u+1:0,this.m_normals[u].x=this.m_vertices[y].y-this.m_vertices[v].y,this.m_normals[u].y=-(this.m_vertices[y].x-this.m_vertices[v].x),this.m_normals[u].Normalize();for(u=0;u<this.m_vertexCount;++u)v=u,y=u+1<this.m_vertexCount?u+1:0;this.m_R.SetM(this.m_body.m_R);this.m_position.x=this.m_body.m_position.x+(this.m_R.col1.x*this.m_localCentroid.x+this.m_R.col2.x*this.m_localCentroid.y);this.m_position.y=this.m_body.m_position.y+(this.m_R.col1.y*this.m_localCentroid.x+this.m_R.col2.y*this.m_localCentroid.y);b2PolyShape.tAbsR.col1.x=this.m_R.col1.x*this.m_localOBB.R.col1.x+this.m_R.col2.x*this.m_localOBB.R.col1.y;b2PolyShape.tAbsR.col1.y=this.m_R.col1.y*this.m_localOBB.R.col1.x+this.m_R.col2.y*this.m_localOBB.R.col1.y;b2PolyShape.tAbsR.col2.x=this.m_R.col1.x*this.m_localOBB.R.col2.x+this.m_R.col2.x*this.m_localOBB.R.col2.y;b2PolyShape.tAbsR.col2.y=this.m_R.col1.y*this.m_localOBB.R.col2.x+this.m_R.col2.y*this.m_localOBB.R.col2.y;b2PolyShape.tAbsR.Abs();e=b2PolyShape.tAbsR.col1.x*this.m_localOBB.extents.x+b2PolyShape.tAbsR.col2.x*this.m_localOBB.extents.y;o=b2PolyShape.tAbsR.col1.y*this.m_localOBB.extents.x+b2PolyShape.tAbsR.col2.y*this.m_localOBB.extents.y;ut=this.m_position.x+(this.m_R.col1.x*this.m_localOBB.center.x+this.m_R.col2.x*this.m_localOBB.center.y);ft=this.m_position.y+(this.m_R.col1.y*this.m_localOBB.center.x+this.m_R.col2.y*this.m_localOBB.center.y);c.minVertex.x=ut-e;c.minVertex.y=ft-o;c.maxVertex.x=ut+e;c.maxVertex.y=ft+o;et=this.m_body.m_world.m_broadPhase;this.m_proxyId=et.InRange(c)?et.CreateProxy(c,this):b2Pair.b2_nullProxy;this.m_proxyId==b2Pair.b2_nullProxy&&this.m_body.Freeze()},syncAABB:new b2AABB,syncMat:new b2Mat22,Synchronize:function(n,t,i,r){var c,l,a;if(this.m_R.SetM(r),this.m_position.x=this.m_body.m_position.x+(r.col1.x*this.m_localCentroid.x+r.col2.x*this.m_localCentroid.y),this.m_position.y=this.m_body.m_position.y+(r.col1.y*this.m_localCentroid.x+r.col2.y*this.m_localCentroid.y),this.m_proxyId!=b2Pair.b2_nullProxy){var u,f,e=t.col1,o=t.col2,s=this.m_localOBB.R.col1,h=this.m_localOBB.R.col2;this.syncMat.col1.x=e.x*s.x+o.x*s.y;this.syncMat.col1.y=e.y*s.x+o.y*s.y;this.syncMat.col2.x=e.x*h.x+o.x*h.y;this.syncMat.col2.y=e.y*h.x+o.y*h.y;this.syncMat.Abs();u=this.m_localCentroid.x+this.m_localOBB.center.x;f=this.m_localCentroid.y+this.m_localOBB.center.y;c=n.x+(t.col1.x*u+t.col2.x*f);l=n.y+(t.col1.y*u+t.col2.y*f);u=this.syncMat.col1.x*this.m_localOBB.extents.x+this.syncMat.col2.x*this.m_localOBB.extents.y;f=this.syncMat.col1.y*this.m_localOBB.extents.x+this.syncMat.col2.y*this.m_localOBB.extents.y;this.syncAABB.minVertex.x=c-u;this.syncAABB.minVertex.y=l-f;this.syncAABB.maxVertex.x=c+u;this.syncAABB.maxVertex.y=l+f;e=r.col1;o=r.col2;s=this.m_localOBB.R.col1;h=this.m_localOBB.R.col2;this.syncMat.col1.x=e.x*s.x+o.x*s.y;this.syncMat.col1.y=e.y*s.x+o.y*s.y;this.syncMat.col2.x=e.x*h.x+o.x*h.y;this.syncMat.col2.y=e.y*h.x+o.y*h.y;this.syncMat.Abs();u=this.m_localCentroid.x+this.m_localOBB.center.x;f=this.m_localCentroid.y+this.m_localOBB.center.y;c=i.x+(r.col1.x*u+r.col2.x*f);l=i.y+(r.col1.y*u+r.col2.y*f);u=this.syncMat.col1.x*this.m_localOBB.extents.x+this.syncMat.col2.x*this.m_localOBB.extents.y;f=this.syncMat.col1.y*this.m_localOBB.extents.x+this.syncMat.col2.y*this.m_localOBB.extents.y;this.syncAABB.minVertex.x=Math.min(this.syncAABB.minVertex.x,c-u);this.syncAABB.minVertex.y=Math.min(this.syncAABB.minVertex.y,l-f);this.syncAABB.maxVertex.x=Math.max(this.syncAABB.maxVertex.x,c+u);this.syncAABB.maxVertex.y=Math.max(this.syncAABB.maxVertex.y,l+f);a=this.m_body.m_world.m_broadPhase;a.InRange(this.syncAABB)?a.MoveProxy(this.m_proxyId,this.syncAABB):this.m_body.Freeze()}},QuickSync:function(n,t){this.m_R.SetM(t);this.m_position.x=n.x+(t.col1.x*this.m_localCentroid.x+t.col2.x*this.m_localCentroid.y);this.m_position.y=n.y+(t.col1.y*this.m_localCentroid.x+t.col2.y*this.m_localCentroid.y)},ResetProxy:function(n){var r,t;if(this.m_proxyId!=b2Pair.b2_nullProxy){r=n.GetProxy(this.m_proxyId);n.DestroyProxy(this.m_proxyId);r=null;var f=b2Math.b2MulMM(this.m_R,this.m_localOBB.R),e=b2Math.b2AbsM(f),u=b2Math.b2MulMV(e,this.m_localOBB.extents),i=b2Math.b2MulMV(this.m_R,this.m_localOBB.center);i.Add(this.m_position);t=new b2AABB;t.minVertex.SetV(i);t.minVertex.Subtract(u);t.maxVertex.SetV(i);t.maxVertex.Add(u);this.m_proxyId=n.InRange(t)?n.CreateProxy(t,this):b2Pair.b2_nullProxy;this.m_proxyId==b2Pair.b2_nullProxy&&this.m_body.Freeze()}},Support:function(n,t,i){for(var f,e=n*this.m_R.col1.x+t*this.m_R.col1.y,o=n*this.m_R.col2.x+t*this.m_R.col2.y,r=0,s=this.m_coreVertices[0].x*e+this.m_coreVertices[0].y*o,u=1;u<this.m_vertexCount;++u)f=this.m_coreVertices[u].x*e+this.m_coreVertices[u].y*o,f>s&&(r=u,s=f);i.Set(this.m_position.x+(this.m_R.col1.x*this.m_coreVertices[r].x+this.m_R.col2.x*this.m_coreVertices[r].y),this.m_position.y+(this.m_R.col1.y*this.m_coreVertices[r].x+this.m_R.col2.y*this.m_coreVertices[r].y))},m_localCentroid:new b2Vec2,m_localOBB:new b2OBB,m_vertices:null,m_coreVertices:null,m_vertexCount:0,m_normals:null});b2PolyShape.tempVec=new b2Vec2;b2PolyShape.tAbsR=new b2Mat22;b2Body=Class.create();b2Body.prototype={SetOriginPosition:function(n,t){if(!this.IsFrozen()){this.m_rotation=t;this.m_R.Set(this.m_rotation);this.m_position=b2Math.AddVV(n,b2Math.b2MulMV(this.m_R,this.m_center));this.m_position0.SetV(this.m_position);this.m_rotation0=this.m_rotation;for(var i=this.m_shapeList;i!=null;i=i.m_next)i.Synchronize(this.m_position,this.m_R,this.m_position,this.m_R);this.m_world.m_broadPhase.Commit()}},GetOriginPosition:function(){return b2Math.SubtractVV(this.m_position,b2Math.b2MulMV(this.m_R,this.m_center))},SetCenterPosition:function(n,t){if(!this.IsFrozen()){this.m_rotation=t;this.m_R.Set(this.m_rotation);this.m_position.SetV(n);this.m_position0.SetV(this.m_position);this.m_rotation0=this.m_rotation;for(var i=this.m_shapeList;i!=null;i=i.m_next)i.Synchronize(this.m_position,this.m_R,this.m_position,this.m_R);this.m_world.m_broadPhase.Commit()}},GetCenterPosition:function(){return this.m_position},GetRotation:function(){return this.m_rotation},GetRotationMatrix:function(){return this.m_R},SetLinearVelocity:function(n){this.m_linearVelocity.SetV(n)},GetLinearVelocity:function(){return this.m_linearVelocity},SetAngularVelocity:function(n){this.m_angularVelocity=n},GetAngularVelocity:function(){return this.m_angularVelocity},ApplyForce:function(n,t){this.IsSleeping()==!1&&(this.m_force.Add(n),this.m_torque+=b2Math.b2CrossVV(b2Math.SubtractVV(t,this.m_position),n))},ApplyTorque:function(n){this.IsSleeping()==!1&&(this.m_torque+=n)},ApplyImpulse:function(n,t){this.IsSleeping()==!1&&(this.m_linearVelocity.Add(b2Math.MulFV(this.m_invMass,n)),this.m_angularVelocity+=this.m_invI*b2Math.b2CrossVV(b2Math.SubtractVV(t,this.m_position),n))},GetMass:function(){return this.m_mass},GetInertia:function(){return this.m_I},GetWorldPoint:function(n){return b2Math.AddVV(this.m_position,b2Math.b2MulMV(this.m_R,n))},GetWorldVector:function(n){return b2Math.b2MulMV(this.m_R,n)},GetLocalPoint:function(n){return b2Math.b2MulTMV(this.m_R,b2Math.SubtractVV(n,this.m_position))},GetLocalVector:function(n){return b2Math.b2MulTMV(this.m_R,n)},IsStatic:function(){return(this.m_flags&b2Body.e_staticFlag)==b2Body.e_staticFlag},IsFrozen:function(){return(this.m_flags&b2Body.e_frozenFlag)==b2Body.e_frozenFlag},IsSleeping:function(){return(this.m_flags&b2Body.e_sleepFlag)==b2Body.e_sleepFlag},AllowSleeping:function(n){n?this.m_flags|=b2Body.e_allowSleepFlag:(this.m_flags&=~b2Body.e_allowSleepFlag,this.WakeUp())},WakeUp:function(){this.m_flags&=~b2Body.e_sleepFlag;this.m_sleepTime=0},GetShapeList:function(){return this.m_shapeList},GetContactList:function(){return this.m_contactList},GetJointList:function(){return this.m_jointList},GetNext:function(){return this.m_next},GetUserData:function(){return this.m_userData},initialize:function(n,t){var i,u,r,f,e,o;for(this.sMat0=new b2Mat22,this.m_position=new b2Vec2,this.m_R=new b2Mat22(0),this.m_position0=new b2Vec2,i=0,this.m_flags=0,this.m_position.SetV(n.position),this.m_rotation=n.rotation,this.m_R.Set(this.m_rotation),this.m_position0.SetV(this.m_position),this.m_rotation0=this.m_rotation,this.m_world=t,this.m_linearDamping=b2Math.b2Clamp(1-n.linearDamping,0,1),this.m_angularDamping=b2Math.b2Clamp(1-n.angularDamping,0,1),this.m_force=new b2Vec2(0,0),this.m_torque=0,this.m_mass=0,f=new Array(b2Settings.b2_maxShapesPerBody),i=0;i<b2Settings.b2_maxShapesPerBody;i++)f[i]=new b2MassData;for(this.m_shapeCount=0,this.m_center=new b2Vec2(0,0),i=0;i<b2Settings.b2_maxShapesPerBody;++i){if(u=n.shapes[i],u==null)break;r=f[i];u.ComputeMass(r);this.m_mass+=r.mass;this.m_center.x+=r.mass*(u.localPosition.x+r.center.x);this.m_center.y+=r.mass*(u.localPosition.y+r.center.y);++this.m_shapeCount}for(this.m_mass>0?(this.m_center.Multiply(1/this.m_mass),this.m_position.Add(b2Math.b2MulMV(this.m_R,this.m_center))):this.m_flags|=b2Body.e_staticFlag,this.m_I=0,i=0;i<this.m_shapeCount;++i)u=n.shapes[i],r=f[i],this.m_I+=r.I,e=b2Math.SubtractVV(b2Math.AddVV(u.localPosition,r.center),this.m_center),this.m_I+=r.mass*b2Math.b2Dot(e,e);for(this.m_invMass=this.m_mass>0?1/this.m_mass:0,this.m_I>0&&n.preventRotation==!1?this.m_invI=1/this.m_I:(this.m_I=0,this.m_invI=0),this.m_linearVelocity=b2Math.AddVV(n.linearVelocity,b2Math.b2CrossFV(n.angularVelocity,this.m_center)),this.m_angularVelocity=n.angularVelocity,this.m_jointList=null,this.m_contactList=null,this.m_prev=null,this.m_next=null,this.m_shapeList=null,i=0;i<this.m_shapeCount;++i)u=n.shapes[i],o=b2Shape.Create(u,this,this.m_center),o.m_next=this.m_shapeList,this.m_shapeList=o;this.m_sleepTime=0;n.allowSleep&&(this.m_flags|=b2Body.e_allowSleepFlag);n.isSleeping&&(this.m_flags|=b2Body.e_sleepFlag);(this.m_flags&b2Body.e_sleepFlag||this.m_invMass==0)&&(this.m_linearVelocity.Set(0,0),this.m_angularVelocity=0);this.m_userData=n.userData},Destroy:function(){for(var n=this.m_shapeList,t;n;)t=n,n=n.m_next,b2Shape.Destroy(t)},sMat0:new b2Mat22,SynchronizeShapes:function(){this.sMat0.Set(this.m_rotation0);for(var n=this.m_shapeList;n!=null;n=n.m_next)n.Synchronize(this.m_position0,this.sMat0,this.m_position,this.m_R)},QuickSyncShapes:function(){for(var n=this.m_shapeList;n!=null;n=n.m_next)n.QuickSync(this.m_position,this.m_R)},IsConnected:function(n){for(var t=this.m_jointList;t!=null;t=t.next)if(t.other==n)return t.joint.m_collideConnected==!1;return!1},Freeze:function(){this.m_flags|=b2Body.e_frozenFlag;this.m_linearVelocity.SetZero();this.m_angularVelocity=0;for(var n=this.m_shapeList;n!=null;n=n.m_next)n.DestroyProxy()},m_flags:0,m_position:new b2Vec2,m_rotation:null,m_R:new b2Mat22(0),m_position0:new b2Vec2,m_rotation0:null,m_linearVelocity:null,m_angularVelocity:null,m_force:null,m_torque:null,m_center:null,m_world:null,m_prev:null,m_next:null,m_shapeList:null,m_shapeCount:0,m_jointList:null,m_contactList:null,m_mass:null,m_invMass:null,m_I:null,m_invI:null,m_linearDamping:null,m_angularDamping:null,m_sleepTime:null,m_userData:null};b2Body.e_staticFlag=1;b2Body.e_frozenFlag=2;b2Body.e_islandFlag=4;b2Body.e_sleepFlag=8;b2Body.e_allowSleepFlag=16;b2Body.e_destroyFlag=32;b2BodyDef=Class.create();b2BodyDef.prototype={initialize:function(){this.shapes=[];this.userData=null;for(var n=0;n<b2Settings.b2_maxShapesPerBody;n++)this.shapes[n]=null;this.position=new b2Vec2(0,0);this.rotation=0;this.linearVelocity=new b2Vec2(0,0);this.angularVelocity=0;this.linearDamping=0;this.angularDamping=0;this.allowSleep=!0;this.isSleeping=!1;this.preventRotation=!1},userData:null,shapes:[],position:null,rotation:null,linearVelocity:null,angularVelocity:null,linearDamping:null,angularDamping:null,allowSleep:null,isSleeping:null,preventRotation:null,AddShape:function(n){for(var t=0;t<b2Settings.b2_maxShapesPerBody;++t)if(this.shapes[t]==null){this.shapes[t]=n;break}}};b2CollisionFilter=Class.create();b2CollisionFilter.prototype={ShouldCollide:function(n,t){if(n.m_groupIndex==t.m_groupIndex&&n.m_groupIndex!=0)return n.m_groupIndex>0;return(n.m_maskBits&t.m_categoryBits)!=0&&(n.m_categoryBits&t.m_maskBits)!=0},initialize:function(){}};b2CollisionFilter.b2_defaultFilter=new b2CollisionFilter;b2Island=Class.create();b2Island.prototype={initialize:function(n,t,i,r){var u=0;for(this.m_bodyCapacity=n,this.m_contactCapacity=t,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_bodies=new Array(n),u=0;u<n;u++)this.m_bodies[u]=null;for(this.m_contacts=new Array(t),u=0;u<t;u++)this.m_contacts[u]=null;for(this.m_joints=new Array(i),u=0;u<i;u++)this.m_joints[u]=null;this.m_allocator=r},Clear:function(){this.m_bodyCount=0;this.m_contactCount=0;this.m_jointCount=0},Solve:function(n,t){for(var r=0,i,u,f,o,e,s,r=0;r<this.m_bodyCount;++r)(i=this.m_bodies[r],i.m_invMass!=0)&&(i.m_linearVelocity.Add(b2Math.MulFV(n.dt,b2Math.AddVV(t,b2Math.MulFV(i.m_invMass,i.m_force)))),i.m_angularVelocity+=n.dt*i.m_invI*i.m_torque,i.m_linearVelocity.Multiply(i.m_linearDamping),i.m_angularVelocity*=i.m_angularDamping,i.m_position0.SetV(i.m_position),i.m_rotation0=i.m_rotation);for(u=new b2ContactSolver(this.m_contacts,this.m_contactCount,this.m_allocator),u.PreSolve(),r=0;r<this.m_jointCount;++r)this.m_joints[r].PrepareVelocitySolver();for(r=0;r<n.iterations;++r)for(u.SolveVelocityConstraints(),f=0;f<this.m_jointCount;++f)this.m_joints[f].SolveVelocityConstraints(n);for(r=0;r<this.m_bodyCount;++r)(i=this.m_bodies[r],i.m_invMass!=0)&&(i.m_position.x+=n.dt*i.m_linearVelocity.x,i.m_position.y+=n.dt*i.m_linearVelocity.y,i.m_rotation+=n.dt*i.m_angularVelocity,i.m_R.Set(i.m_rotation));for(r=0;r<this.m_jointCount;++r)this.m_joints[r].PreparePositionSolver();if(b2World.s_enablePositionCorrection)for(b2Island.m_positionIterationCount=0;b2Island.m_positionIterationCount<n.iterations;++b2Island.m_positionIterationCount){for(o=u.SolvePositionConstraints(b2Settings.b2_contactBaumgarte),e=!0,r=0;r<this.m_jointCount;++r)s=this.m_joints[r].SolvePositionConstraints(),e=e&&s;if(o&&e)break}for(u.PostSolve(),r=0;r<this.m_bodyCount;++r)(i=this.m_bodies[r],i.m_invMass!=0)&&(i.m_R.Set(i.m_rotation),i.SynchronizeShapes(),i.m_force.Set(0,0),i.m_torque=0)},UpdateSleep:function(n){for(var i=0,t,r=Number.MAX_VALUE,u=b2Settings.b2_linearSleepTolerance*b2Settings.b2_linearSleepTolerance,f=b2Settings.b2_angularSleepTolerance*b2Settings.b2_angularSleepTolerance,i=0;i<this.m_bodyCount;++i)(t=this.m_bodies[i],t.m_invMass!=0)&&((t.m_flags&b2Body.e_allowSleepFlag)==0&&(t.m_sleepTime=0,r=0),(t.m_flags&b2Body.e_allowSleepFlag)==0||t.m_angularVelocity*t.m_angularVelocity>f||b2Math.b2Dot(t.m_linearVelocity,t.m_linearVelocity)>u?(t.m_sleepTime=0,r=0):(t.m_sleepTime+=n,r=b2Math.b2Min(r,t.m_sleepTime)));if(r>=b2Settings.b2_timeToSleep)for(i=0;i<this.m_bodyCount;++i)t=this.m_bodies[i],t.m_flags|=b2Body.e_sleepFlag},AddBody:function(n){this.m_bodies[this.m_bodyCount++]=n},AddContact:function(n){this.m_contacts[this.m_contactCount++]=n},AddJoint:function(n){this.m_joints[this.m_jointCount++]=n},m_allocator:null,m_bodies:null,m_contacts:null,m_joints:null,m_bodyCount:0,m_jointCount:0,m_contactCount:0,m_bodyCapacity:0,m_contactCapacity:0,m_jointCapacity:0,m_positionError:null};b2Island.m_positionIterationCount=0;b2TimeStep=Class.create();b2TimeStep.prototype={dt:null,inv_dt:null,iterations:0,initialize:function(){}};b2ContactNode=Class.create();b2ContactNode.prototype={other:null,contact:null,prev:null,next:null,initialize:function(){}};b2Contact=Class.create();b2Contact.prototype={GetManifolds:function(){return null},GetManifoldCount:function(){return this.m_manifoldCount},GetNext:function(){return this.m_next},GetShape1:function(){return this.m_shape1},GetShape2:function(){return this.m_shape2},initialize:function(n,t){if(this.m_node1=new b2ContactNode,this.m_node2=new b2ContactNode,this.m_flags=0,!n||!t){this.m_shape1=null;this.m_shape2=null;return}this.m_shape1=n;this.m_shape2=t;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_prev=null;this.m_next=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null},Evaluate:function(){},m_flags:0,m_prev:null,m_next:null,m_node1:new b2ContactNode,m_node2:new b2ContactNode,m_shape1:null,m_shape2:null,m_manifoldCount:0,m_friction:null,m_restitution:null};b2Contact.e_islandFlag=1;b2Contact.e_destroyFlag=2;b2Contact.AddType=function(n,t,i,r){b2Contact.s_registers[i][r].createFcn=n;b2Contact.s_registers[i][r].destroyFcn=t;b2Contact.s_registers[i][r].primary=!0;i!=r&&(b2Contact.s_registers[r][i].createFcn=n,b2Contact.s_registers[r][i].destroyFcn=t,b2Contact.s_registers[r][i].primary=!1)};b2Contact.InitializeRegisters=function(){var n,t;for(b2Contact.s_registers=new Array(b2Shape.e_shapeTypeCount),n=0;n<b2Shape.e_shapeTypeCount;n++)for(b2Contact.s_registers[n]=new Array(b2Shape.e_shapeTypeCount),t=0;t<b2Shape.e_shapeTypeCount;t++)b2Contact.s_registers[n][t]=new b2ContactRegister;b2Contact.AddType(b2CircleContact.Create,b2CircleContact.Destroy,b2Shape.e_circleShape,b2Shape.e_circleShape);b2Contact.AddType(b2PolyAndCircleContact.Create,b2PolyAndCircleContact.Destroy,b2Shape.e_polyShape,b2Shape.e_circleShape);b2Contact.AddType(b2PolyContact.Create,b2PolyContact.Destroy,b2Shape.e_polyShape,b2Shape.e_polyShape)};b2Contact.Create=function(n,t,i){var r,u,e;b2Contact.s_initialized==!1&&(b2Contact.InitializeRegisters(),b2Contact.s_initialized=!0);var o=n.m_type,s=t.m_type,f=b2Contact.s_registers[o][s].createFcn;if(f){if(b2Contact.s_registers[o][s].primary)return f(n,t,i);for(r=f(t,n,i),u=0;u<r.GetManifoldCount();++u)e=r.GetManifolds()[u],e.normal=e.normal.Negative();return r}return null};b2Contact.Destroy=function(n,t){n.GetManifoldCount()>0&&(n.m_shape1.m_body.WakeUp(),n.m_shape2.m_body.WakeUp());var i=n.m_shape1.m_type,r=n.m_shape2.m_type,u=b2Contact.s_registers[i][r].destroyFcn;u(n,t)};b2Contact.s_registers=null;b2Contact.s_initialized=!1;b2ContactConstraint=Class.create();b2ContactConstraint.prototype={initialize:function(){this.normal=new b2Vec2;this.points=new Array(b2Settings.b2_maxManifoldPoints);for(var n=0;n<b2Settings.b2_maxManifoldPoints;n++)this.points[n]=new b2ContactConstraintPoint},points:null,normal:new b2Vec2,manifold:null,body1:null,body2:null,friction:null,restitution:null,pointCount:0};b2ContactConstraintPoint=Class.create();b2ContactConstraintPoint.prototype={localAnchor1:new b2Vec2,localAnchor2:new b2Vec2,normalImpulse:null,tangentImpulse:null,positionImpulse:null,normalMass:null,tangentMass:null,separation:null,velocityBias:null,initialize:function(){this.localAnchor1=new b2Vec2;this.localAnchor2=new b2Vec2}};b2ContactRegister=Class.create();b2ContactRegister.prototype={createFcn:null,destroyFcn:null,primary:null,initialize:function(){}};b2ContactSolver=Class.create();b2ContactSolver.prototype={initialize:function(n,t,i){var r,y,s,nt,k,b,h,f;for(this.m_constraints=[],this.m_allocator=i,r=0,this.m_constraintCount=0,r=0;r<t;++r)this.m_constraintCount+=n[r].GetManifoldCount();for(r=0;r<this.m_constraintCount;r++)this.m_constraints[r]=new b2ContactConstraint;for(nt=0,r=0;r<t;++r){var p=n[r],e=p.m_shape1.m_body,o=p.m_shape2.m_body,yt=p.GetManifoldCount(),pt=p.GetManifolds(),wt=p.m_friction,bt=p.m_restitution,kt=e.m_linearVelocity.x,dt=e.m_linearVelocity.y,gt=o.m_linearVelocity.x,ni=o.m_linearVelocity.y,tt=e.m_angularVelocity,it=o.m_angularVelocity;for(k=0;k<yt;++k){var w=pt[k],d=w.normal.x,g=w.normal.y,u=this.m_constraints[nt];for(u.body1=e,u.body2=o,u.manifold=w,u.normal.x=d,u.normal.y=g,u.pointCount=w.pointCount,u.friction=wt,u.restitution=bt,b=0;b<u.pointCount;++b){h=w.points[b];f=u.points[b];f.normalImpulse=h.normalImpulse;f.tangentImpulse=h.tangentImpulse;f.separation=h.separation;var c=h.position.x-e.m_position.x,l=h.position.y-e.m_position.y,a=h.position.x-o.m_position.x,v=h.position.y-o.m_position.y;y=f.localAnchor1;s=e.m_R;y.x=c*s.col1.x+l*s.col1.y;y.y=c*s.col2.x+l*s.col2.y;y=f.localAnchor2;s=o.m_R;y.x=a*s.col1.x+v*s.col1.y;y.y=a*s.col2.x+v*s.col2.y;var rt=c*c+l*l,ut=a*a+v*v,ft=c*d+l*g,et=a*d+v*g,ot=e.m_invMass+o.m_invMass;ot+=e.m_invI*(rt-ft*ft)+o.m_invI*(ut-et*et);f.normalMass=1/ot;var st=g,ht=-d,ct=c*st+l*ht,lt=a*st+v*ht,at=e.m_invMass+o.m_invMass;at+=e.m_invI*(rt-ct*ct)+o.m_invI*(ut-lt*lt);f.tangentMass=1/at;f.velocityBias=0;f.separation>0&&(f.velocityBias=-60*f.separation);var ti=gt+-it*v-kt- -tt*l,ii=ni+it*a-dt-tt*c,vt=u.normal.x*ti+u.normal.y*ii;vt<-b2Settings.b2_velocityThreshold&&(f.velocityBias+=-u.restitution*vt)}++nt}}},PreSolve:function(){for(var w,b,k,d,c,n,t,l=0;l<this.m_constraintCount;++l){var i=this.m_constraints[l],f=i.body1,e=i.body2,a=f.m_invMass,g=f.m_invI,v=e.m_invMass,nt=e.m_invI,y=i.normal.x,p=i.normal.y,tt=p,it=-y,r=0,o=0;if(b2World.s_enableWarmStarting)for(o=i.pointCount,r=0;r<o;++r){var u=i.points[r],s=u.normalImpulse*y+u.tangentImpulse*tt,h=u.normalImpulse*p+u.tangentImpulse*it;t=f.m_R;n=u.localAnchor1;w=t.col1.x*n.x+t.col2.x*n.y;b=t.col1.y*n.x+t.col2.y*n.y;t=e.m_R;n=u.localAnchor2;k=t.col1.x*n.x+t.col2.x*n.y;d=t.col1.y*n.x+t.col2.y*n.y;f.m_angularVelocity-=g*(w*h-b*s);f.m_linearVelocity.x-=a*s;f.m_linearVelocity.y-=a*h;e.m_angularVelocity+=nt*(k*h-d*s);e.m_linearVelocity.x+=v*s;e.m_linearVelocity.y+=v*h;u.positionImpulse=0}else for(o=i.pointCount,r=0;r<o;++r)c=i.points[r],c.normalImpulse=0,c.tangentImpulse=0,c.positionImpulse=0}},SolveVelocityConstraints:function(){for(var ct,lt,ft,k=0,n,y,p,w,b,d,g,t,l,i,r,u,f,it=0;it<this.m_constraintCount;++it){var s=this.m_constraints[it],a=s.body1,v=s.body2,h=a.m_angularVelocity,e=a.m_linearVelocity,c=v.m_angularVelocity,o=v.m_linearVelocity,nt=a.m_invMass,et=a.m_invI,tt=v.m_invMass,ot=v.m_invI,rt=s.normal.x,ut=s.normal.y,st=ut,ht=-rt,at=s.pointCount;for(k=0;k<at;++k)n=s.points[k],u=a.m_R,f=n.localAnchor1,y=u.col1.x*f.x+u.col2.x*f.y,p=u.col1.y*f.x+u.col2.y*f.y,u=v.m_R,f=n.localAnchor2,w=u.col1.x*f.x+u.col2.x*f.y,b=u.col1.y*f.x+u.col2.y*f.y,d=o.x+-c*b-e.x- -h*p,g=o.y+c*w-e.y-h*y,ct=d*rt+g*ut,t=-n.normalMass*(ct-n.velocityBias),l=b2Math.b2Max(n.normalImpulse+t,0),t=l-n.normalImpulse,i=t*rt,r=t*ut,e.x-=nt*i,e.y-=nt*r,h-=et*(y*r-p*i),o.x+=tt*i,o.y+=tt*r,c+=ot*(w*r-b*i),n.normalImpulse=l,d=o.x+-c*b-e.x- -h*p,g=o.y+c*w-e.y-h*y,lt=d*st+g*ht,t=n.tangentMass*-lt,ft=s.friction*n.normalImpulse,l=b2Math.b2Clamp(n.tangentImpulse+t,-ft,ft),t=l-n.tangentImpulse,i=t*st,r=t*ht,e.x-=nt*i,e.y-=nt*r,h-=et*(y*r-p*i),o.x+=tt*i,o.y+=tt*r,c+=ot*(w*r-b*i),n.tangentImpulse=l;a.m_angularVelocity=h;v.m_angularVelocity=c}},SolvePositionConstraints:function(n){for(var l,r,d,g,o,s,v=0,t,i,y=0;y<this.m_constraintCount;++y){var e=this.m_constraints[y],u=e.body1,f=e.body2,h=u.m_position,p=u.m_rotation,c=f.m_position,w=f.m_rotation,nt=u.m_invMass,et=u.m_invI,tt=f.m_invMass,ot=f.m_invI,b=e.normal.x,k=e.normal.y,wt=k,bt=-b,st=e.pointCount;for(l=0;l<st;++l){r=e.points[l];t=u.m_R;i=r.localAnchor1;d=t.col1.x*i.x+t.col2.x*i.y;g=t.col1.y*i.x+t.col2.y*i.y;t=f.m_R;i=r.localAnchor2;var it=t.col1.x*i.x+t.col2.x*i.y,rt=t.col1.y*i.x+t.col2.y*i.y,ht=h.x+d,ct=h.y+g,lt=c.x+it,at=c.y+rt,vt=lt-ht,yt=at-ct,ut=vt*b+yt*k+r.separation;v=b2Math.b2Min(v,ut);var pt=n*b2Math.b2Clamp(ut+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),a=-r.normalMass*pt,ft=r.positionImpulse;r.positionImpulse=b2Math.b2Max(ft+a,0);a=r.positionImpulse-ft;o=a*b;s=a*k;h.x-=nt*o;h.y-=nt*s;p-=et*(d*s-g*o);u.m_R.Set(p);c.x+=tt*o;c.y+=tt*s;w+=ot*(it*s-rt*o);f.m_R.Set(w)}u.m_rotation=p;f.m_rotation=w}return v>=-b2Settings.b2_linearSlop},PostSolve:function(){for(var i,f,n,r,u,t=0;t<this.m_constraintCount;++t)for(i=this.m_constraints[t],f=i.manifold,n=0;n<i.pointCount;++n)r=f.points[n],u=i.points[n],r.normalImpulse=u.normalImpulse,r.tangentImpulse=u.tangentImpulse},m_allocator:null,m_constraints:[],m_constraintCount:0};b2CircleContact=Class.create();Object.extend(b2CircleContact.prototype,b2Contact.prototype);Object.extend(b2CircleContact.prototype,{initialize:function(n,t){if(this.m_node1=new b2ContactNode,this.m_node2=new b2ContactNode,this.m_flags=0,!n||!t){this.m_shape1=null;this.m_shape2=null;return}this.m_shape1=n;this.m_shape2=t;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_prev=null;this.m_next=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null;this.m_manifold=[new b2Manifold];this.m_manifold[0].pointCount=0;this.m_manifold[0].points[0].normalImpulse=0;this.m_manifold[0].points[0].tangentImpulse=0},Evaluate:function(){b2Collision.b2CollideCircle(this.m_manifold[0],this.m_shape1,this.m_shape2,!1);this.m_manifoldCount=this.m_manifold[0].pointCount>0?1:0},GetManifolds:function(){return this.m_manifold},m_manifold:[new b2Manifold]});b2CircleContact.Create=function(n,t){return new b2CircleContact(n,t)};b2CircleContact.Destroy=function(){};b2Conservative=Class.create();b2Conservative.prototype={initialize:function(){}};b2Conservative.R1=new b2Mat22;b2Conservative.R2=new b2Mat22;b2Conservative.x1=new b2Vec2;b2Conservative.x2=new b2Vec2;b2Conservative.Conservative=function(n,t){var r=n.GetBody(),i=t.GetBody(),ht=r.m_position.x-r.m_position0.x,ct=r.m_position.y-r.m_position0.y,g=r.m_rotation-r.m_rotation0,lt=i.m_position.x-i.m_position0.x,at=i.m_position.y-i.m_position0.y,nt=i.m_rotation-i.m_rotation0,vt=n.GetMaxRadius(),yt=t.GetMaxRadius(),tt=r.m_position0.x,it=r.m_position0.y,rt=r.m_rotation0,ut=i.m_position0.x,ft=i.m_position0.y,et=i.m_rotation0,y=tt,p=it,o=rt,a=ut,v=ft,s=et,c,w,pt,b,st,l,k;b2Conservative.R1.Set(o);b2Conservative.R2.Set(s);n.QuickSync(p1,b2Conservative.R1);t.QuickSync(p2,b2Conservative.R2);var e=0,u,f,ot=0,h=!0;for(c=0;c<10;++c){if(w=b2Distance.Distance(b2Conservative.x1,b2Conservative.x2,n,t),w<b2Settings.b2_linearSlop){h=c==0?!1:!0;break}if(c==0){if(u=b2Conservative.x2.x-b2Conservative.x1.x,f=b2Conservative.x2.y-b2Conservative.x1.y,pt=Math.sqrt(u*u+f*f),b=u*(ht-lt)+f*(ct-at)+Math.abs(g)*vt+Math.abs(nt)*yt,Math.abs(b)<Number.MIN_VALUE){h=!1;break}ot=1/b}if(st=w*ot,l=e+st,l<0||1<l){h=!1;break}if(l<(1+100*Number.MIN_VALUE)*e){h=!0;break}e=l;y=tt+e*v1.x;p=it+e*v1.y;o=rt+e*g;a=ut+e*v2.x;v=ft+e*v2.y;s=et+e*nt;b2Conservative.R1.Set(o);b2Conservative.R2.Set(s);n.QuickSync(p1,b2Conservative.R1);t.QuickSync(p2,b2Conservative.R2)}return h?(u=b2Conservative.x2.x-b2Conservative.x1.x,f=b2Conservative.x2.y-b2Conservative.x1.y,k=Math.sqrt(u*u+f*f),k>FLT_EPSILON&&(d*=b2_linearSlop/k),r.IsStatic()?(r.m_position.x=y,r.m_position.y=p):(r.m_position.x=y-u,r.m_position.y=p-f),r.m_rotation=o,r.m_R.Set(o),r.QuickSyncShapes(),i.IsStatic()?(i.m_position.x=a,i.m_position.y=v):(i.m_position.x=a+u,i.m_position.y=v+f),i.m_position.x=a+u,i.m_position.y=v+f,i.m_rotation=s,i.m_R.Set(s),i.QuickSyncShapes(),!0):(n.QuickSync(r.m_position,r.m_R),t.QuickSync(i.m_position,i.m_R),!1)};b2NullContact=Class.create();Object.extend(b2NullContact.prototype,b2Contact.prototype);Object.extend(b2NullContact.prototype,{initialize:function(n,t){if(this.m_node1=new b2ContactNode,this.m_node2=new b2ContactNode,this.m_flags=0,!n||!t){this.m_shape1=null;this.m_shape2=null;return}this.m_shape1=n;this.m_shape2=t;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_prev=null;this.m_next=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null},Evaluate:function(){},GetManifolds:function(){return null}});b2PolyAndCircleContact=Class.create();Object.extend(b2PolyAndCircleContact.prototype,b2Contact.prototype);Object.extend(b2PolyAndCircleContact.prototype,{initialize:function(n,t){if(this.m_node1=new b2ContactNode,this.m_node2=new b2ContactNode,this.m_flags=0,!n||!t){this.m_shape1=null;this.m_shape2=null;return}this.m_shape1=n;this.m_shape2=t;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_prev=null;this.m_next=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null;this.m_manifold=[new b2Manifold];b2Settings.b2Assert(this.m_shape1.m_type==b2Shape.e_polyShape);b2Settings.b2Assert(this.m_shape2.m_type==b2Shape.e_circleShape);this.m_manifold[0].pointCount=0;this.m_manifold[0].points[0].normalImpulse=0;this.m_manifold[0].points[0].tangentImpulse=0},Evaluate:function(){b2Collision.b2CollidePolyAndCircle(this.m_manifold[0],this.m_shape1,this.m_shape2,!1);this.m_manifoldCount=this.m_manifold[0].pointCount>0?1:0},GetManifolds:function(){return this.m_manifold},m_manifold:[new b2Manifold]});b2PolyAndCircleContact.Create=function(n,t){return new b2PolyAndCircleContact(n,t)};b2PolyAndCircleContact.Destroy=function(){};b2PolyContact=Class.create();Object.extend(b2PolyContact.prototype,b2Contact.prototype);Object.extend(b2PolyContact.prototype,{initialize:function(n,t){if(this.m_node1=new b2ContactNode,this.m_node2=new b2ContactNode,this.m_flags=0,!n||!t){this.m_shape1=null;this.m_shape2=null;return}this.m_shape1=n;this.m_shape2=t;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_prev=null;this.m_next=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null;this.m0=new b2Manifold;this.m_manifold=[new b2Manifold];this.m_manifold[0].pointCount=0},m0:new b2Manifold,Evaluate:function(){for(var u,f,s,e,t,h,i,o,c,n=this.m_manifold[0],l=this.m0.points,r=0;r<n.pointCount;r++)u=l[r],f=n.points[r],u.normalImpulse=f.normalImpulse,u.tangentImpulse=f.tangentImpulse,u.id=f.id.Copy();if(this.m0.pointCount=n.pointCount,b2Collision.b2CollidePoly(n,this.m_shape1,this.m_shape2,!1),n.pointCount>0){for(s=[!1,!1],e=0;e<n.pointCount;++e)for(t=n.points[e],t.normalImpulse=0,t.tangentImpulse=0,h=t.id.key,i=0;i<this.m0.pointCount;++i)if(s[i]!=!0&&(o=this.m0.points[i],c=o.id,c.key==h)){s[i]=!0;t.normalImpulse=o.normalImpulse;t.tangentImpulse=o.tangentImpulse;break}this.m_manifoldCount=1}else this.m_manifoldCount=0},GetManifolds:function(){return this.m_manifold},m_manifold:[new b2Manifold]});b2PolyContact.Create=function(n,t){return new b2PolyContact(n,t)};b2PolyContact.Destroy=function(){};b2ContactManager=Class.create();Object.extend(b2ContactManager.prototype,b2PairCallback.prototype);Object.extend(b2ContactManager.prototype,{initialize:function(){this.m_nullContact=new b2NullContact;this.m_world=null;this.m_destroyImmediate=!1},PairAdded:function(n,t){var r=n,u=t,e=r.m_body,f=u.m_body,o,s,i;return e.IsStatic()&&f.IsStatic()?this.m_nullContact:r.m_body==u.m_body?this.m_nullContact:f.IsConnected(e)?this.m_nullContact:this.m_world.m_filter!=null&&this.m_world.m_filter.ShouldCollide(r,u)==!1?this.m_nullContact:(f.m_invMass==0&&(o=r,r=u,u=o,s=e,e=f,f=s),i=b2Contact.Create(r,u,this.m_world.m_blockAllocator),i==null)?this.m_nullContact:(i.m_prev=null,i.m_next=this.m_world.m_contactList,this.m_world.m_contactList!=null&&(this.m_world.m_contactList.m_prev=i),this.m_world.m_contactList=i,this.m_world.m_contactCount++,i)},PairRemoved:function(n,t,i){if(i!=null){var r=i;r!=this.m_nullContact&&(this.m_destroyImmediate==!0?(this.DestroyContact(r),r=null):r.m_flags|=b2Contact.e_destroyFlag)}},DestroyContact:function(n){if(n.m_prev&&(n.m_prev.m_next=n.m_next),n.m_next&&(n.m_next.m_prev=n.m_prev),n==this.m_world.m_contactList&&(this.m_world.m_contactList=n.m_next),n.GetManifoldCount()>0){var r=n.m_shape1.m_body,u=n.m_shape2.m_body,t=n.m_node1,i=n.m_node2;r.WakeUp();u.WakeUp();t.prev&&(t.prev.next=t.next);t.next&&(t.next.prev=t.prev);t==r.m_contactList&&(r.m_contactList=t.next);t.prev=null;t.next=null;i.prev&&(i.prev.next=i.next);i.next&&(i.next.prev=i.prev);i==u.m_contactList&&(u.m_contactList=i.next);i.prev=null;i.next=null}b2Contact.Destroy(n,this.m_world.m_blockAllocator);--this.m_world.m_contactCount},CleanContactList:function(){for(var n=this.m_world.m_contactList,t;n!=null;)t=n,n=n.m_next,t.m_flags&b2Contact.e_destroyFlag&&(this.DestroyContact(t),t=null)},Collide:function(){for(var f,e,r,u,i,n,t=this.m_world.m_contactList;t!=null;t=t.m_next)t.m_shape1.m_body.IsSleeping()&&t.m_shape2.m_body.IsSleeping()||(f=t.GetManifoldCount(),t.Evaluate(),e=t.GetManifoldCount(),f==0&&e>0?(r=t.m_shape1.m_body,u=t.m_shape2.m_body,i=t.m_node1,n=t.m_node2,i.contact=t,i.other=u,i.prev=null,i.next=r.m_contactList,i.next!=null&&(i.next.prev=t.m_node1),r.m_contactList=t.m_node1,n.contact=t,n.other=r,n.prev=null,n.next=u.m_contactList,n.next!=null&&(n.next.prev=n),u.m_contactList=n):f>0&&e==0&&(r=t.m_shape1.m_body,u=t.m_shape2.m_body,i=t.m_node1,n=t.m_node2,i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),i==r.m_contactList&&(r.m_contactList=i.next),i.prev=null,i.next=null,n.prev&&(n.prev.next=n.next),n.next&&(n.next.prev=n.prev),n==u.m_contactList&&(u.m_contactList=n.next),n.prev=null,n.next=null))},m_world:null,m_nullContact:new b2NullContact,m_destroyImmediate:null});b2World=Class.create();b2World.prototype={initialize:function(n,t,i){this.step=new b2TimeStep;this.m_contactManager=new b2ContactManager;this.m_listener=null;this.m_filter=b2CollisionFilter.b2_defaultFilter;this.m_bodyList=null;this.m_contactList=null;this.m_jointList=null;this.m_bodyCount=0;this.m_contactCount=0;this.m_jointCount=0;this.m_bodyDestroyList=null;this.m_allowSleep=i;this.m_gravity=t;this.m_contactManager.m_world=this;this.m_broadPhase=new b2BroadPhase(n,this.m_contactManager);var r=new b2BodyDef;this.m_groundBody=this.CreateBody(r)},SetListener:function(n){this.m_listener=n},SetFilter:function(n){this.m_filter=n},CreateBody:function(n){var t=new b2Body(n,this);return t.m_prev=null,t.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=t),this.m_bodyList=t,++this.m_bodyCount,t},DestroyBody:function(n){n.m_flags&b2Body.e_destroyFlag||(n.m_prev&&(n.m_prev.m_next=n.m_next),n.m_next&&(n.m_next.m_prev=n.m_prev),n==this.m_bodyList&&(this.m_bodyList=n.m_next),n.m_flags|=b2Body.e_destroyFlag,--this.m_bodyCount,n.m_prev=null,n.m_next=this.m_bodyDestroyList,this.m_bodyDestroyList=n)},CleanBodyList:function(){var n,i,t,r;for(this.m_contactManager.m_destroyImmediate=!0,n=this.m_bodyDestroyList;n;){for(i=n,n=n.m_next,t=i.m_jointList;t;)r=t,t=t.next,this.m_listener&&this.m_listener.NotifyJointDestroyed(r.joint),this.DestroyJoint(r.joint);i.Destroy()}this.m_bodyDestroyList=null;this.m_contactManager.m_destroyImmediate=!1},CreateJoint:function(n){var t=b2Joint.Create(n,this.m_blockAllocator),r,i;if(t.m_prev=null,t.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=t),this.m_jointList=t,++this.m_jointCount,t.m_node1.joint=t,t.m_node1.other=t.m_body2,t.m_node1.prev=null,t.m_node1.next=t.m_body1.m_jointList,t.m_body1.m_jointList&&(t.m_body1.m_jointList.prev=t.m_node1),t.m_body1.m_jointList=t.m_node1,t.m_node2.joint=t,t.m_node2.other=t.m_body1,t.m_node2.prev=null,t.m_node2.next=t.m_body2.m_jointList,t.m_body2.m_jointList&&(t.m_body2.m_jointList.prev=t.m_node2),t.m_body2.m_jointList=t.m_node2,n.collideConnected==!1)for(r=n.body1.m_shapeCount<n.body2.m_shapeCount?n.body1:n.body2,i=r.m_shapeList;i;i=i.m_next)i.ResetProxy(this.m_broadPhase);return t},DestroyJoint:function(n){var f=n.m_collideConnected,t,i,u,r;if(n.m_prev&&(n.m_prev.m_next=n.m_next),n.m_next&&(n.m_next.m_prev=n.m_prev),n==this.m_jointList&&(this.m_jointList=n.m_next),t=n.m_body1,i=n.m_body2,t.WakeUp(),i.WakeUp(),n.m_node1.prev&&(n.m_node1.prev.next=n.m_node1.next),n.m_node1.next&&(n.m_node1.next.prev=n.m_node1.prev),n.m_node1==t.m_jointList&&(t.m_jointList=n.m_node1.next),n.m_node1.prev=null,n.m_node1.next=null,n.m_node2.prev&&(n.m_node2.prev.next=n.m_node2.next),n.m_node2.next&&(n.m_node2.next.prev=n.m_node2.prev),n.m_node2==i.m_jointList&&(i.m_jointList=n.m_node2.next),n.m_node2.prev=null,n.m_node2.next=null,b2Joint.Destroy(n,this.m_blockAllocator),--this.m_jointCount,f==!1)for(u=t.m_shapeCount<i.m_shapeCount?t:i,r=u.m_shapeList;r;r=r.m_next)r.ResetProxy(this.m_broadPhase)},GetGroundBody:function(){return this.m_groundBody},step:new b2TimeStep,Step:function(n,t){var i,u,r,c,l,p,s,v,o,h,f,e,a,y;for(this.step.dt=n,this.step.iterations=t,this.step.inv_dt=n>0?1/n:0,this.m_positionIterationCount=0,this.m_contactManager.CleanContactList(),this.CleanBodyList(),this.m_contactManager.Collide(),r=new b2Island(this.m_bodyCount,this.m_contactCount,this.m_jointCount,this.m_stackAllocator),i=this.m_bodyList;i!=null;i=i.m_next)i.m_flags&=~b2Body.e_islandFlag;for(c=this.m_contactList;c!=null;c=c.m_next)c.m_flags&=~b2Contact.e_islandFlag;for(l=this.m_jointList;l!=null;l=l.m_next)l.m_islandFlag=!1;for(p=this.m_bodyCount,s=new Array(this.m_bodyCount),v=0;v<this.m_bodyCount;v++)s[v]=null;for(o=this.m_bodyList;o!=null;o=o.m_next)if(!(o.m_flags&(b2Body.e_staticFlag|b2Body.e_islandFlag|b2Body.e_sleepFlag|b2Body.e_frozenFlag))){for(r.Clear(),h=0,s[h++]=o,o.m_flags|=b2Body.e_islandFlag;h>0;)if(i=s[--h],r.AddBody(i),i.m_flags&=~b2Body.e_sleepFlag,!(i.m_flags&b2Body.e_staticFlag)){for(f=i.m_contactList;f!=null;f=f.next)f.contact.m_flags&b2Contact.e_islandFlag||(r.AddContact(f.contact),f.contact.m_flags|=b2Contact.e_islandFlag,u=f.other,u.m_flags&b2Body.e_islandFlag)||(s[h++]=u,u.m_flags|=b2Body.e_islandFlag);for(e=i.m_jointList;e!=null;e=e.next)e.joint.m_islandFlag!=!0&&((r.AddJoint(e.joint),e.joint.m_islandFlag=!0,u=e.other,u.m_flags&b2Body.e_islandFlag)||(s[h++]=u,u.m_flags|=b2Body.e_islandFlag))}for(r.Solve(this.step,this.m_gravity),this.m_positionIterationCount=b2Math.b2Max(this.m_positionIterationCount,b2Island.m_positionIterationCount),this.m_allowSleep&&r.UpdateSleep(n),a=0;a<r.m_bodyCount;++a)i=r.m_bodies[a],i.m_flags&b2Body.e_staticFlag&&(i.m_flags&=~b2Body.e_islandFlag),i.IsFrozen()&&this.m_listener&&(y=this.m_listener.NotifyBoundaryViolated(i),y==b2WorldListener.b2_destroyBody&&(this.DestroyBody(i),i=null,r.m_bodies[a]=null))}this.m_broadPhase.Commit()},Query:function(n,t,i){for(var u=[],f=this.m_broadPhase.QueryAABB(n,u,i),r=0;r<f;++r)t[r]=u[r];return f},GetBodyList:function(){return this.m_bodyList},GetJointList:function(){return this.m_jointList},GetContactList:function(){return this.m_contactList},m_blockAllocator:null,m_stackAllocator:null,m_broadPhase:null,m_contactManager:new b2ContactManager,m_bodyList:null,m_contactList:null,m_jointList:null,m_bodyCount:0,m_contactCount:0,m_jointCount:0,m_bodyDestroyList:null,m_gravity:null,m_allowSleep:null,m_groundBody:null,m_listener:null,m_filter:null,m_positionIterationCount:0};b2World.s_enablePositionCorrection=1;b2World.s_enableWarmStarting=1;b2WorldListener=Class.create();b2WorldListener.prototype={NotifyJointDestroyed:function(){},NotifyBoundaryViolated:function(){return b2WorldListener.b2_freezeBody},initialize:function(){}};b2WorldListener.b2_freezeBody=0;b2WorldListener.b2_destroyBody=1;b2JointNode=Class.create();b2JointNode.prototype={other:null,joint:null,prev:null,next:null,initialize:function(){}};b2Joint=Class.create();b2Joint.prototype={GetType:function(){return this.m_type},GetAnchor1:function(){return null},GetAnchor2:function(){return null},GetReactionForce:function(){return null},GetReactionTorque:function(){return 0},GetBody1:function(){return this.m_body1},GetBody2:function(){return this.m_body2},GetNext:function(){return this.m_next},GetUserData:function(){return this.m_userData},initialize:function(n){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=n.type;this.m_prev=null;this.m_next=null;this.m_body1=n.body1;this.m_body2=n.body2;this.m_collideConnected=n.collideConnected;this.m_islandFlag=!1;this.m_userData=n.userData},PrepareVelocitySolver:function(){},SolveVelocityConstraints:function(){},PreparePositionSolver:function(){},SolvePositionConstraints:function(){return!1},m_type:0,m_prev:null,m_next:null,m_node1:new b2JointNode,m_node2:new b2JointNode,m_body1:null,m_body2:null,m_islandFlag:null,m_collideConnected:null,m_userData:null};b2Joint.Create=function(n){var t=null;switch(n.type){case b2Joint.e_distanceJoint:t=new b2DistanceJoint(n);break;case b2Joint.e_mouseJoint:t=new b2MouseJoint(n);break;case b2Joint.e_prismaticJoint:t=new b2PrismaticJoint(n);break;case b2Joint.e_revoluteJoint:t=new b2RevoluteJoint(n);break;case b2Joint.e_pulleyJoint:t=new b2PulleyJoint(n);break;case b2Joint.e_gearJoint:t=new b2GearJoint(n)}return t};b2Joint.Destroy=function(){};b2Joint.e_unknownJoint=0;b2Joint.e_revoluteJoint=1;b2Joint.e_prismaticJoint=2;b2Joint.e_distanceJoint=3;b2Joint.e_pulleyJoint=4;b2Joint.e_mouseJoint=5;b2Joint.e_gearJoint=6;b2Joint.e_inactiveLimit=0;b2Joint.e_atLowerLimit=1;b2Joint.e_atUpperLimit=2;b2Joint.e_equalLimits=3;b2JointDef=Class.create();b2JointDef.prototype={initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=!1},type:0,userData:null,body1:null,body2:null,collideConnected:null};b2DistanceJoint=Class.create();Object.extend(b2DistanceJoint.prototype,b2Joint.prototype);Object.extend(b2DistanceJoint.prototype,{initialize:function(n){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=n.type;this.m_prev=null;this.m_next=null;this.m_body1=n.body1;this.m_body2=n.body2;this.m_collideConnected=n.collideConnected;this.m_islandFlag=!1;this.m_userData=n.userData;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_u=new b2Vec2;var t,i,r;t=this.m_body1.m_R;i=n.anchorPoint1.x-this.m_body1.m_position.x;r=n.anchorPoint1.y-this.m_body1.m_position.y;this.m_localAnchor1.x=i*t.col1.x+r*t.col1.y;this.m_localAnchor1.y=i*t.col2.x+r*t.col2.y;t=this.m_body2.m_R;i=n.anchorPoint2.x-this.m_body2.m_position.x;r=n.anchorPoint2.y-this.m_body2.m_position.y;this.m_localAnchor2.x=i*t.col1.x+r*t.col1.y;this.m_localAnchor2.y=i*t.col2.x+r*t.col2.y;i=n.anchorPoint2.x-n.anchorPoint1.x;r=n.anchorPoint2.y-n.anchorPoint1.y;this.m_length=Math.sqrt(i*i+r*r);this.m_impulse=0},PrepareVelocitySolver:function(){var n,r,u,f,e,o,s,h,t,i;n=this.m_body1.m_R;r=n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y;u=n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y;n=this.m_body2.m_R;f=n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y;e=n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y;this.m_u.x=this.m_body2.m_position.x+f-this.m_body1.m_position.x-r;this.m_u.y=this.m_body2.m_position.y+e-this.m_body1.m_position.y-u;o=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y);o>b2Settings.b2_linearSlop?this.m_u.Multiply(1/o):this.m_u.SetZero();s=r*this.m_u.y-u*this.m_u.x;h=f*this.m_u.y-e*this.m_u.x;this.m_mass=this.m_body1.m_invMass+this.m_body1.m_invI*s*s+this.m_body2.m_invMass+this.m_body2.m_invI*h*h;this.m_mass=1/this.m_mass;b2World.s_enableWarmStarting?(t=this.m_impulse*this.m_u.x,i=this.m_impulse*this.m_u.y,this.m_body1.m_linearVelocity.x-=this.m_body1.m_invMass*t,this.m_body1.m_linearVelocity.y-=this.m_body1.m_invMass*i,this.m_body1.m_angularVelocity-=this.m_body1.m_invI*(r*i-u*t),this.m_body2.m_linearVelocity.x+=this.m_body2.m_invMass*t,this.m_body2.m_linearVelocity.y+=this.m_body2.m_invMass*i,this.m_body2.m_angularVelocity+=this.m_body2.m_invI*(f*i-e*t)):this.m_impulse=0},SolveVelocityConstraints:function(){var n,r,u,t,i;n=this.m_body1.m_R;r=n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y;u=n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y;n=this.m_body2.m_R;var e=n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y,o=n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y,s=this.m_body1.m_linearVelocity.x+-this.m_body1.m_angularVelocity*u,h=this.m_body1.m_linearVelocity.y+this.m_body1.m_angularVelocity*r,c=this.m_body2.m_linearVelocity.x+-this.m_body2.m_angularVelocity*o,l=this.m_body2.m_linearVelocity.y+this.m_body2.m_angularVelocity*e,a=this.m_u.x*(c-s)+this.m_u.y*(l-h),f=-this.m_mass*a;this.m_impulse+=f;t=f*this.m_u.x;i=f*this.m_u.y;this.m_body1.m_linearVelocity.x-=this.m_body1.m_invMass*t;this.m_body1.m_linearVelocity.y-=this.m_body1.m_invMass*i;this.m_body1.m_angularVelocity-=this.m_body1.m_invI*(r*i-u*t);this.m_body2.m_linearVelocity.x+=this.m_body2.m_invMass*t;this.m_body2.m_linearVelocity.y+=this.m_body2.m_invMass*i;this.m_body2.m_angularVelocity+=this.m_body2.m_invI*(e*i-o*t)},SolvePositionConstraints:function(){var n,e,o,t,h,i,r;n=this.m_body1.m_R;e=n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y;o=n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y;n=this.m_body2.m_R;var c=n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y,l=n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y,u=this.m_body2.m_position.x+c-this.m_body1.m_position.x-e,f=this.m_body2.m_position.y+l-this.m_body1.m_position.y-o,s=Math.sqrt(u*u+f*f);return u/=s,f/=s,t=s-this.m_length,t=b2Math.b2Clamp(t,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection),h=-this.m_mass*t,this.m_u.Set(u,f),i=h*this.m_u.x,r=h*this.m_u.y,this.m_body1.m_position.x-=this.m_body1.m_invMass*i,this.m_body1.m_position.y-=this.m_body1.m_invMass*r,this.m_body1.m_rotation-=this.m_body1.m_invI*(e*r-o*i),this.m_body2.m_position.x+=this.m_body2.m_invMass*i,this.m_body2.m_position.y+=this.m_body2.m_invMass*r,this.m_body2.m_rotation+=this.m_body2.m_invI*(c*r-l*i),this.m_body1.m_R.Set(this.m_body1.m_rotation),this.m_body2.m_R.Set(this.m_body2.m_rotation),b2Math.b2Abs(t)<b2Settings.b2_linearSlop},GetAnchor1:function(){return b2Math.AddVV(this.m_body1.m_position,b2Math.b2MulMV(this.m_body1.m_R,this.m_localAnchor1))},GetAnchor2:function(){return b2Math.AddVV(this.m_body2.m_position,b2Math.b2MulMV(this.m_body2.m_R,this.m_localAnchor2))},GetReactionForce:function(n){var t=new b2Vec2;return t.SetV(this.m_u),t.Multiply(this.m_impulse*n),t},GetReactionTorque:function(){return 0},m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_u:new b2Vec2,m_impulse:null,m_mass:null,m_length:null});b2DistanceJointDef=Class.create();Object.extend(b2DistanceJointDef.prototype,b2JointDef.prototype);Object.extend(b2DistanceJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=!1;this.anchorPoint1=new b2Vec2;this.anchorPoint2=new b2Vec2;this.type=b2Joint.e_distanceJoint},anchorPoint1:new b2Vec2,anchorPoint2:new b2Vec2});b2Jacobian=Class.create();b2Jacobian.prototype={linear1:new b2Vec2,angular1:null,linear2:new b2Vec2,angular2:null,SetZero:function(){this.linear1.SetZero();this.angular1=0;this.linear2.SetZero();this.angular2=0},Set:function(n,t,i,r){this.linear1.SetV(n);this.angular1=t;this.linear2.SetV(i);this.angular2=r},Compute:function(n,t,i,r){return this.linear1.x*n.x+this.linear1.y*n.y+this.angular1*t+(this.linear2.x*i.x+this.linear2.y*i.y)+this.angular2*r},initialize:function(){this.linear1=new b2Vec2;this.linear2=new b2Vec2}};b2GearJoint=Class.create();Object.extend(b2GearJoint.prototype,b2Joint.prototype);Object.extend(b2GearJoint.prototype,{GetAnchor1:function(){var n=this.m_body1.m_R;return new b2Vec2(this.m_body1.m_position.x+(n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y),this.m_body1.m_position.y+(n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y))},GetAnchor2:function(){var n=this.m_body2.m_R;return new b2Vec2(this.m_body2.m_position.x+(n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y),this.m_body2.m_position.y+(n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y))},GetReactionForce:function(){return new b2Vec2},GetReactionTorque:function(){return 0},GetRatio:function(){return this.m_ratio},initialize:function(n){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=n.type;this.m_prev=null;this.m_next=null;this.m_body1=n.body1;this.m_body2=n.body2;this.m_collideConnected=n.collideConnected;this.m_islandFlag=!1;this.m_userData=n.userData;this.m_groundAnchor1=new b2Vec2;this.m_groundAnchor2=new b2Vec2;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_J=new b2Jacobian;this.m_revolute1=null;this.m_prismatic1=null;this.m_revolute2=null;this.m_prismatic2=null;var t,i;this.m_ground1=n.joint1.m_body1;this.m_body1=n.joint1.m_body2;n.joint1.m_type==b2Joint.e_revoluteJoint?(this.m_revolute1=n.joint1,this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2),t=this.m_revolute1.GetJointAngle()):(this.m_prismatic1=n.joint1,this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2),t=this.m_prismatic1.GetJointTranslation());this.m_ground2=n.joint2.m_body1;this.m_body2=n.joint2.m_body2;n.joint2.m_type==b2Joint.e_revoluteJoint?(this.m_revolute2=n.joint2,this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2),i=this.m_revolute2.GetJointAngle()):(this.m_prismatic2=n.joint2,this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2),i=this.m_prismatic2.GetJointTranslation());this.m_ratio=n.ratio;this.m_constant=t+this.m_ratio*i;this.m_impulse=0},PrepareVelocitySolver:function(){var c=this.m_ground1,l=this.m_ground2,t=this.m_body1,i=this.m_body2,f,e,s,h,n,r,u,o=0;this.m_J.SetZero();this.m_revolute1?(this.m_J.angular1=-1,o+=t.m_invI):(n=c.m_R,r=this.m_prismatic1.m_localXAxis1,f=n.col1.x*r.x+n.col2.x*r.y,e=n.col1.y*r.x+n.col2.y*r.y,n=t.m_R,s=n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y,h=n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y,u=s*e-h*f,this.m_J.linear1.Set(-f,-e),this.m_J.angular1=-u,o+=t.m_invMass+t.m_invI*u*u);this.m_revolute2?(this.m_J.angular2=-this.m_ratio,o+=this.m_ratio*this.m_ratio*i.m_invI):(n=l.m_R,r=this.m_prismatic2.m_localXAxis1,f=n.col1.x*r.x+n.col2.x*r.y,e=n.col1.y*r.x+n.col2.y*r.y,n=i.m_R,s=n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y,h=n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y,u=s*e-h*f,this.m_J.linear2.Set(-this.m_ratio*f,-this.m_ratio*e),this.m_J.angular2=-this.m_ratio*u,o+=this.m_ratio*this.m_ratio*(i.m_invMass+i.m_invI*u*u));this.m_mass=1/o;t.m_linearVelocity.x+=t.m_invMass*this.m_impulse*this.m_J.linear1.x;t.m_linearVelocity.y+=t.m_invMass*this.m_impulse*this.m_J.linear1.y;t.m_angularVelocity+=t.m_invI*this.m_impulse*this.m_J.angular1;i.m_linearVelocity.x+=i.m_invMass*this.m_impulse*this.m_J.linear2.x;i.m_linearVelocity.y+=i.m_invMass*this.m_impulse*this.m_J.linear2.y;i.m_angularVelocity+=i.m_invI*this.m_impulse*this.m_J.angular2},SolveVelocityConstraints:function(){var n=this.m_body1,t=this.m_body2,r=this.m_J.Compute(n.m_linearVelocity,n.m_angularVelocity,t.m_linearVelocity,t.m_angularVelocity),i=-this.m_mass*r;this.m_impulse+=i;n.m_linearVelocity.x+=n.m_invMass*i*this.m_J.linear1.x;n.m_linearVelocity.y+=n.m_invMass*i*this.m_J.linear1.y;n.m_angularVelocity+=n.m_invI*i*this.m_J.angular1;t.m_linearVelocity.x+=t.m_invMass*i*this.m_J.linear2.x;t.m_linearVelocity.y+=t.m_invMass*i*this.m_J.linear2.y;t.m_angularVelocity+=t.m_invI*i*this.m_J.angular2},SolvePositionConstraints:function(){var n=this.m_body1,t=this.m_body2,r,u,f,i;return r=this.m_revolute1?this.m_revolute1.GetJointAngle():this.m_prismatic1.GetJointTranslation(),u=this.m_revolute2?this.m_revolute2.GetJointAngle():this.m_prismatic2.GetJointTranslation(),f=this.m_constant-(r+this.m_ratio*u),i=-this.m_mass*f,n.m_position.x+=n.m_invMass*i*this.m_J.linear1.x,n.m_position.y+=n.m_invMass*i*this.m_J.linear1.y,n.m_rotation+=n.m_invI*i*this.m_J.angular1,t.m_position.x+=t.m_invMass*i*this.m_J.linear2.x,t.m_position.y+=t.m_invMass*i*this.m_J.linear2.y,t.m_rotation+=t.m_invI*i*this.m_J.angular2,n.m_R.Set(n.m_rotation),t.m_R.Set(t.m_rotation),0<b2Settings.b2_linearSlop},m_ground1:null,m_ground2:null,m_revolute1:null,m_prismatic1:null,m_revolute2:null,m_prismatic2:null,m_groundAnchor1:new b2Vec2,m_groundAnchor2:new b2Vec2,m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_J:new b2Jacobian,m_constant:null,m_ratio:null,m_mass:null,m_impulse:null});b2GearJointDef=Class.create();Object.extend(b2GearJointDef.prototype,b2JointDef.prototype);Object.extend(b2GearJointDef.prototype,{initialize:function(){this.type=b2Joint.e_gearJoint;this.joint1=null;this.joint2=null;this.ratio=1},joint1:null,joint2:null,ratio:null});b2MouseJoint=Class.create();Object.extend(b2MouseJoint.prototype,b2Joint.prototype);Object.extend(b2MouseJoint.prototype,{GetAnchor1:function(){return this.m_target},GetAnchor2:function(){var n=b2Math.b2MulMV(this.m_body2.m_R,this.m_localAnchor);return n.Add(this.m_body2.m_position),n},GetReactionForce:function(n){var t=new b2Vec2;return t.SetV(this.m_impulse),t.Multiply(n),t},GetReactionTorque:function(){return 0},SetTarget:function(n){this.m_body2.WakeUp();this.m_target=n},initialize:function(n){var t,i;this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=n.type;this.m_prev=null;this.m_next=null;this.m_body1=n.body1;this.m_body2=n.body2;this.m_collideConnected=n.collideConnected;this.m_islandFlag=!1;this.m_userData=n.userData;this.K=new b2Mat22;this.K1=new b2Mat22;this.K2=new b2Mat22;this.m_localAnchor=new b2Vec2;this.m_target=new b2Vec2;this.m_impulse=new b2Vec2;this.m_ptpMass=new b2Mat22;this.m_C=new b2Vec2;this.m_target.SetV(n.target);t=this.m_target.x-this.m_body2.m_position.x;i=this.m_target.y-this.m_body2.m_position.y;this.m_localAnchor.x=t*this.m_body2.m_R.col1.x+i*this.m_body2.m_R.col1.y;this.m_localAnchor.y=t*this.m_body2.m_R.col2.x+i*this.m_body2.m_R.col2.y;this.m_maxForce=n.maxForce;this.m_impulse.SetZero();var f=this.m_body2.m_mass,r=2*b2Settings.b2_pi*n.frequencyHz,e=2*f*n.dampingRatio*r,u=f*r*r;this.m_gamma=1/(e+n.timeStep*u);this.m_beta=n.timeStep*u/(e+n.timeStep*u)},K:new b2Mat22,K1:new b2Mat22,K2:new b2Mat22,PrepareVelocitySolver:function(){var n=this.m_body2,r,e,o;r=n.m_R;var t=r.col1.x*this.m_localAnchor.x+r.col2.x*this.m_localAnchor.y,i=r.col1.y*this.m_localAnchor.x+r.col2.y*this.m_localAnchor.y,f=n.m_invMass,u=n.m_invI;this.K1.col1.x=f;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=f;this.K2.col1.x=u*i*i;this.K2.col2.x=-u*t*i;this.K2.col1.y=-u*t*i;this.K2.col2.y=u*t*t;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.col1.x+=this.m_gamma;this.K.col2.y+=this.m_gamma;this.K.Invert(this.m_ptpMass);this.m_C.x=n.m_position.x+t-this.m_target.x;this.m_C.y=n.m_position.y+i-this.m_target.y;n.m_angularVelocity*=.98;e=this.m_impulse.x;o=this.m_impulse.y;n.m_linearVelocity.x+=f*e;n.m_linearVelocity.y+=f*o;n.m_angularVelocity+=u*(t*o-i*e)},SolveVelocityConstraints:function(n){var t=this.m_body2,i,f;i=t.m_R;var e=i.col1.x*this.m_localAnchor.x+i.col2.x*this.m_localAnchor.y,o=i.col1.y*this.m_localAnchor.x+i.col2.y*this.m_localAnchor.y,c=t.m_linearVelocity.x+-t.m_angularVelocity*o,l=t.m_linearVelocity.y+t.m_angularVelocity*e;i=this.m_ptpMass;var s=c+this.m_beta*n.inv_dt*this.m_C.x+this.m_gamma*this.m_impulse.x,h=l+this.m_beta*n.inv_dt*this.m_C.y+this.m_gamma*this.m_impulse.y,r=-(i.col1.x*s+i.col2.x*h),u=-(i.col1.y*s+i.col2.y*h),a=this.m_impulse.x,v=this.m_impulse.y;this.m_impulse.x+=r;this.m_impulse.y+=u;f=this.m_impulse.Length();f>n.dt*this.m_maxForce&&this.m_impulse.Multiply(n.dt*this.m_maxForce/f);r=this.m_impulse.x-a;u=this.m_impulse.y-v;t.m_linearVelocity.x+=t.m_invMass*r;t.m_linearVelocity.y+=t.m_invMass*u;t.m_angularVelocity+=t.m_invI*(e*u-o*r)},SolvePositionConstraints:function(){return!0},m_localAnchor:new b2Vec2,m_target:new b2Vec2,m_impulse:new b2Vec2,m_ptpMass:new b2Mat22,m_C:new b2Vec2,m_maxForce:null,m_beta:null,m_gamma:null});b2MouseJointDef=Class.create();Object.extend(b2MouseJointDef.prototype,b2JointDef.prototype);Object.extend(b2MouseJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=!1;this.target=new b2Vec2;this.type=b2Joint.e_mouseJoint;this.maxForce=0;this.frequencyHz=5;this.dampingRatio=.7;this.timeStep=1/60},target:new b2Vec2,maxForce:null,frequencyHz:null,dampingRatio:null,timeStep:null});b2PrismaticJoint=Class.create();Object.extend(b2PrismaticJoint.prototype,b2Joint.prototype);Object.extend(b2PrismaticJoint.prototype,{GetAnchor1:function(){var t=this.m_body1,n=new b2Vec2;return n.SetV(this.m_localAnchor1),n.MulM(t.m_R),n.Add(t.m_position),n},GetAnchor2:function(){var t=this.m_body2,n=new b2Vec2;return n.SetV(this.m_localAnchor2),n.MulM(t.m_R),n.Add(t.m_position),n},GetJointTranslation:function(){var t=this.m_body1,i=this.m_body2,n,r,u;n=t.m_R;r=n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y;u=n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y;n=i.m_R;var f=n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y,e=n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y,o=t.m_position.x+r,s=t.m_position.y+u,h=i.m_position.x+f,c=i.m_position.y+e,l=h-o,a=c-s;n=t.m_R;var v=n.col1.x*this.m_localXAxis1.x+n.col2.x*this.m_localXAxis1.y,y=n.col1.y*this.m_localXAxis1.x+n.col2.y*this.m_localXAxis1.y;return v*l+y*a},GetJointSpeed:function(){var t=this.m_body1,i=this.m_body2,n,u,f;n=t.m_R;u=n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y;f=n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y;n=i.m_R;var e=n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y,o=n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y,v=t.m_position.x+u,y=t.m_position.y+f,p=i.m_position.x+e,w=i.m_position.y+o,b=p-v,k=w-y;n=t.m_R;var s=n.col1.x*this.m_localXAxis1.x+n.col2.x*this.m_localXAxis1.y,h=n.col1.y*this.m_localXAxis1.x+n.col2.y*this.m_localXAxis1.y,c=t.m_linearVelocity,l=i.m_linearVelocity,r=t.m_angularVelocity,a=i.m_angularVelocity;return b*-r*h+k*r*s+(s*(l.x+-a*o-c.x- -r*f)+h*(l.y+a*e-c.y-r*u))},GetMotorForce:function(n){return n*this.m_motorImpulse},SetMotorSpeed:function(n){this.m_motorSpeed=n},SetMotorForce:function(n){this.m_maxMotorForce=n},GetReactionForce:function(n){var i=n*this.m_limitImpulse,t=this.m_body1.m_R;var r=i*(t.col1.x*this.m_localXAxis1.x+t.col2.x*this.m_localXAxis1.y),u=i*(t.col1.y*this.m_localXAxis1.x+t.col2.y*this.m_localXAxis1.y),f=i*(t.col1.x*this.m_localYAxis1.x+t.col2.x*this.m_localYAxis1.y),e=i*(t.col1.y*this.m_localYAxis1.x+t.col2.y*this.m_localYAxis1.y);return new b2Vec2(r+f,u+e)},GetReactionTorque:function(n){return n*this.m_angularImpulse},initialize:function(n){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=n.type;this.m_prev=null;this.m_next=null;this.m_body1=n.body1;this.m_body2=n.body2;this.m_collideConnected=n.collideConnected;this.m_islandFlag=!1;this.m_userData=n.userData;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_localXAxis1=new b2Vec2;this.m_localYAxis1=new b2Vec2;this.m_linearJacobian=new b2Jacobian;this.m_motorJacobian=new b2Jacobian;var t,i,r;t=this.m_body1.m_R;i=n.anchorPoint.x-this.m_body1.m_position.x;r=n.anchorPoint.y-this.m_body1.m_position.y;this.m_localAnchor1.Set(i*t.col1.x+r*t.col1.y,i*t.col2.x+r*t.col2.y);t=this.m_body2.m_R;i=n.anchorPoint.x-this.m_body2.m_position.x;r=n.anchorPoint.y-this.m_body2.m_position.y;this.m_localAnchor2.Set(i*t.col1.x+r*t.col1.y,i*t.col2.x+r*t.col2.y);t=this.m_body1.m_R;i=n.axis.x;r=n.axis.y;this.m_localXAxis1.Set(i*t.col1.x+r*t.col1.y,i*t.col2.x+r*t.col2.y);this.m_localYAxis1.x=-this.m_localXAxis1.y;this.m_localYAxis1.y=this.m_localXAxis1.x;this.m_initialAngle=this.m_body2.m_rotation-this.m_body1.m_rotation;this.m_linearJacobian.SetZero();this.m_linearMass=0;this.m_linearImpulse=0;this.m_angularMass=0;this.m_angularImpulse=0;this.m_motorJacobian.SetZero();this.m_motorMass=0;this.m_motorImpulse=0;this.m_limitImpulse=0;this.m_limitPositionImpulse=0;this.m_lowerTranslation=n.lowerTranslation;this.m_upperTranslation=n.upperTranslation;this.m_maxMotorForce=n.motorForce;this.m_motorSpeed=n.motorSpeed;this.m_enableLimit=n.enableLimit;this.m_enableMotor=n.enableMotor},PrepareVelocitySolver:function(){var t=this.m_body1,i=this.m_body2,n,p,w,r,u;n=t.m_R;p=n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y;w=n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y;n=i.m_R;var l=n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y,a=n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y,f=t.m_invMass,e=i.m_invMass,o=t.m_invI,s=i.m_invI;n=t.m_R;var h=n.col1.x*this.m_localYAxis1.x+n.col2.x*this.m_localYAxis1.y,c=n.col1.y*this.m_localYAxis1.x+n.col2.y*this.m_localYAxis1.y,v=i.m_position.x+l-t.m_position.x,y=i.m_position.y+a-t.m_position.y;if(this.m_linearJacobian.linear1.x=-h,this.m_linearJacobian.linear1.y=-c,this.m_linearJacobian.linear2.x=h,this.m_linearJacobian.linear2.y=c,this.m_linearJacobian.angular1=-(v*c-y*h),this.m_linearJacobian.angular2=l*c-a*h,this.m_linearMass=f+o*this.m_linearJacobian.angular1*this.m_linearJacobian.angular1+e+s*this.m_linearJacobian.angular2*this.m_linearJacobian.angular2,this.m_linearMass=1/this.m_linearMass,this.m_angularMass=1/(o+s),(this.m_enableLimit||this.m_enableMotor)&&(n=t.m_R,r=n.col1.x*this.m_localXAxis1.x+n.col2.x*this.m_localXAxis1.y,u=n.col1.y*this.m_localXAxis1.x+n.col2.y*this.m_localXAxis1.y,this.m_motorJacobian.linear1.x=-r,this.m_motorJacobian.linear1.y=-u,this.m_motorJacobian.linear2.x=r,this.m_motorJacobian.linear2.y=u,this.m_motorJacobian.angular1=-(v*u-y*r),this.m_motorJacobian.angular2=l*u-a*r,this.m_motorMass=f+o*this.m_motorJacobian.angular1*this.m_motorJacobian.angular1+e+s*this.m_motorJacobian.angular2*this.m_motorJacobian.angular2,this.m_motorMass=1/this.m_motorMass,this.m_enableLimit)){var k=v-p,d=y-w,b=r*k+u*d;b2Math.b2Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop?this.m_limitState=b2Joint.e_equalLimits:b<=this.m_lowerTranslation?(this.m_limitState!=b2Joint.e_atLowerLimit&&(this.m_limitImpulse=0),this.m_limitState=b2Joint.e_atLowerLimit):b>=this.m_upperTranslation?(this.m_limitState!=b2Joint.e_atUpperLimit&&(this.m_limitImpulse=0),this.m_limitState=b2Joint.e_atUpperLimit):(this.m_limitState=b2Joint.e_inactiveLimit,this.m_limitImpulse=0)}if(this.m_enableMotor==!1&&(this.m_motorImpulse=0),this.m_enableLimit==!1&&(this.m_limitImpulse=0),b2World.s_enableWarmStarting){var g=this.m_linearImpulse*this.m_linearJacobian.linear1.x+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear1.x,nt=this.m_linearImpulse*this.m_linearJacobian.linear1.y+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear1.y,tt=this.m_linearImpulse*this.m_linearJacobian.linear2.x+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear2.x,it=this.m_linearImpulse*this.m_linearJacobian.linear2.y+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear2.y,rt=this.m_linearImpulse*this.m_linearJacobian.angular1-this.m_angularImpulse+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.angular1,ut=this.m_linearImpulse*this.m_linearJacobian.angular2+this.m_angularImpulse+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.angular2;t.m_linearVelocity.x+=f*g;t.m_linearVelocity.y+=f*nt;t.m_angularVelocity+=o*rt;i.m_linearVelocity.x+=e*tt;i.m_linearVelocity.y+=e*it;i.m_angularVelocity+=s*ut}else this.m_linearImpulse=0,this.m_angularImpulse=0,this.m_limitImpulse=0,this.m_motorImpulse=0;this.m_limitPositionImpulse=0},SolveVelocityConstraints:function(n){var t=this.m_body1,i=this.m_body2,e=t.m_invMass,o=i.m_invMass,s=t.m_invI,h=i.m_invI,c,y=this.m_linearJacobian.Compute(t.m_linearVelocity,t.m_angularVelocity,i.m_linearVelocity,i.m_angularVelocity),f=-this.m_linearMass*y,a,l,v,r;if(this.m_linearImpulse+=f,t.m_linearVelocity.x+=e*f*this.m_linearJacobian.linear1.x,t.m_linearVelocity.y+=e*f*this.m_linearJacobian.linear1.y,t.m_angularVelocity+=s*f*this.m_linearJacobian.angular1,i.m_linearVelocity.x+=o*f*this.m_linearJacobian.linear2.x,i.m_linearVelocity.y+=o*f*this.m_linearJacobian.linear2.y,i.m_angularVelocity+=h*f*this.m_linearJacobian.angular2,a=i.m_angularVelocity-t.m_angularVelocity,l=-this.m_angularMass*a,this.m_angularImpulse+=l,t.m_angularVelocity-=s*l,i.m_angularVelocity+=h*l,this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){var p=this.m_motorJacobian.Compute(t.m_linearVelocity,t.m_angularVelocity,i.m_linearVelocity,i.m_angularVelocity)-this.m_motorSpeed,u=-this.m_motorMass*p,w=this.m_motorImpulse;this.m_motorImpulse=b2Math.b2Clamp(this.m_motorImpulse+u,-n.dt*this.m_maxMotorForce,n.dt*this.m_maxMotorForce);u=this.m_motorImpulse-w;t.m_linearVelocity.x+=e*u*this.m_motorJacobian.linear1.x;t.m_linearVelocity.y+=e*u*this.m_motorJacobian.linear1.y;t.m_angularVelocity+=s*u*this.m_motorJacobian.angular1;i.m_linearVelocity.x+=o*u*this.m_motorJacobian.linear2.x;i.m_linearVelocity.y+=o*u*this.m_motorJacobian.linear2.y;i.m_angularVelocity+=h*u*this.m_motorJacobian.angular2}this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit&&(v=this.m_motorJacobian.Compute(t.m_linearVelocity,t.m_angularVelocity,i.m_linearVelocity,i.m_angularVelocity),r=-this.m_motorMass*v,this.m_limitState==b2Joint.e_equalLimits?this.m_limitImpulse+=r:this.m_limitState==b2Joint.e_atLowerLimit?(c=this.m_limitImpulse,this.m_limitImpulse=b2Math.b2Max(this.m_limitImpulse+r,0),r=this.m_limitImpulse-c):this.m_limitState==b2Joint.e_atUpperLimit&&(c=this.m_limitImpulse,this.m_limitImpulse=b2Math.b2Min(this.m_limitImpulse+r,0),r=this.m_limitImpulse-c),t.m_linearVelocity.x+=e*r*this.m_motorJacobian.linear1.x,t.m_linearVelocity.y+=e*r*this.m_motorJacobian.linear1.y,t.m_angularVelocity+=s*r*this.m_motorJacobian.angular1,i.m_linearVelocity.x+=o*r*this.m_motorJacobian.linear2.x,i.m_linearVelocity.y+=o*r*this.m_motorJacobian.linear2.y,i.m_angularVelocity+=h*r*this.m_motorJacobian.angular2)},SolvePositionConstraints:function(){var u,s,t=this.m_body1,i=this.m_body2,h=t.m_invMass,c=i.m_invMass,rt=t.m_invI,ut=i.m_invI,n,l,a,e,f,o,tt,ft;n=t.m_R;l=n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y;a=n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y;n=i.m_R;var y=n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y,p=n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y,w=t.m_position.x+l,b=t.m_position.y+a,k=i.m_position.x+y,d=i.m_position.y+p,g=k-w,nt=d-b;n=t.m_R;var et=n.col1.x*this.m_localYAxis1.x+n.col2.x*this.m_localYAxis1.y,ot=n.col1.y*this.m_localYAxis1.x+n.col2.y*this.m_localYAxis1.y,v=et*g+ot*nt;if(v=b2Math.b2Clamp(v,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection),e=-this.m_linearMass*v,t.m_position.x+=h*e*this.m_linearJacobian.linear1.x,t.m_position.y+=h*e*this.m_linearJacobian.linear1.y,t.m_rotation+=rt*e*this.m_linearJacobian.angular1,i.m_position.x+=c*e*this.m_linearJacobian.linear2.x,i.m_position.y+=c*e*this.m_linearJacobian.linear2.y,i.m_rotation+=ut*e*this.m_linearJacobian.angular2,f=b2Math.b2Abs(v),o=i.m_rotation-t.m_rotation-this.m_initialAngle,o=b2Math.b2Clamp(o,-b2Settings.b2_maxAngularCorrection,b2Settings.b2_maxAngularCorrection),tt=-this.m_angularMass*o,t.m_rotation-=t.m_invI*tt,t.m_R.Set(t.m_rotation),i.m_rotation+=i.m_invI*tt,i.m_R.Set(i.m_rotation),ft=b2Math.b2Abs(o),this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){n=t.m_R;l=n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y;a=n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y;n=i.m_R;y=n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y;p=n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y;w=t.m_position.x+l;b=t.m_position.y+a;k=i.m_position.x+y;d=i.m_position.y+p;g=k-w;nt=d-b;n=t.m_R;var st=n.col1.x*this.m_localXAxis1.x+n.col2.x*this.m_localXAxis1.y,ht=n.col1.y*this.m_localXAxis1.x+n.col2.y*this.m_localXAxis1.y,it=st*g+ht*nt,r=0;this.m_limitState==b2Joint.e_equalLimits?(u=b2Math.b2Clamp(it,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection),r=-this.m_motorMass*u,f=b2Math.b2Max(f,b2Math.b2Abs(o))):this.m_limitState==b2Joint.e_atLowerLimit?(u=it-this.m_lowerTranslation,f=b2Math.b2Max(f,-u),u=b2Math.b2Clamp(u+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),r=-this.m_motorMass*u,s=this.m_limitPositionImpulse,this.m_limitPositionImpulse=b2Math.b2Max(this.m_limitPositionImpulse+r,0),r=this.m_limitPositionImpulse-s):this.m_limitState==b2Joint.e_atUpperLimit&&(u=it-this.m_upperTranslation,f=b2Math.b2Max(f,u),u=b2Math.b2Clamp(u-b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection),r=-this.m_motorMass*u,s=this.m_limitPositionImpulse,this.m_limitPositionImpulse=b2Math.b2Min(this.m_limitPositionImpulse+r,0),r=this.m_limitPositionImpulse-s);t.m_position.x+=h*r*this.m_motorJacobian.linear1.x;t.m_position.y+=h*r*this.m_motorJacobian.linear1.y;t.m_rotation+=rt*r*this.m_motorJacobian.angular1;t.m_R.Set(t.m_rotation);i.m_position.x+=c*r*this.m_motorJacobian.linear2.x;i.m_position.y+=c*r*this.m_motorJacobian.linear2.y;i.m_rotation+=ut*r*this.m_motorJacobian.angular2;i.m_R.Set(i.m_rotation)}return f<=b2Settings.b2_linearSlop&&ft<=b2Settings.b2_angularSlop},m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_localXAxis1:new b2Vec2,m_localYAxis1:new b2Vec2,m_initialAngle:null,m_linearJacobian:new b2Jacobian,m_linearMass:null,m_linearImpulse:null,m_angularMass:null,m_angularImpulse:null,m_motorJacobian:new b2Jacobian,m_motorMass:null,m_motorImpulse:null,m_limitImpulse:null,m_limitPositionImpulse:null,m_lowerTranslation:null,m_upperTranslation:null,m_maxMotorForce:null,m_motorSpeed:null,m_enableLimit:null,m_enableMotor:null,m_limitState:0});b2PrismaticJointDef=Class.create();Object.extend(b2PrismaticJointDef.prototype,b2JointDef.prototype);Object.extend(b2PrismaticJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=!1;this.type=b2Joint.e_prismaticJoint;this.anchorPoint=new b2Vec2(0,0);this.axis=new b2Vec2(0,0);this.lowerTranslation=0;this.upperTranslation=0;this.motorForce=0;this.motorSpeed=0;this.enableLimit=!1;this.enableMotor=!1},anchorPoint:null,axis:null,lowerTranslation:null,upperTranslation:null,motorForce:null,motorSpeed:null,enableLimit:null,enableMotor:null});b2PulleyJoint=Class.create();Object.extend(b2PulleyJoint.prototype,b2Joint.prototype);Object.extend(b2PulleyJoint.prototype,{GetAnchor1:function(){var n=this.m_body1.m_R;return new b2Vec2(this.m_body1.m_position.x+(n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y),this.m_body1.m_position.y+(n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y))},GetAnchor2:function(){var n=this.m_body2.m_R;return new b2Vec2(this.m_body2.m_position.x+(n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y),this.m_body2.m_position.y+(n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y))},GetGroundPoint1:function(){return new b2Vec2(this.m_ground.m_position.x+this.m_groundAnchor1.x,this.m_ground.m_position.y+this.m_groundAnchor1.y)},GetGroundPoint2:function(){return new b2Vec2(this.m_ground.m_position.x+this.m_groundAnchor2.x,this.m_ground.m_position.y+this.m_groundAnchor2.y)},GetReactionForce:function(){return new b2Vec2},GetReactionTorque:function(){return 0},GetLength1:function(){var n=this.m_body1.m_R;var r=this.m_body1.m_position.x+(n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y),u=this.m_body1.m_position.y+(n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y),t=r-(this.m_ground.m_position.x+this.m_groundAnchor1.x),i=u-(this.m_ground.m_position.y+this.m_groundAnchor1.y);return Math.sqrt(t*t+i*i)},GetLength2:function(){var n=this.m_body2.m_R;var r=this.m_body2.m_position.x+(n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y),u=this.m_body2.m_position.y+(n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y),t=r-(this.m_ground.m_position.x+this.m_groundAnchor2.x),i=u-(this.m_ground.m_position.y+this.m_groundAnchor2.y);return Math.sqrt(t*t+i*i)},GetRatio:function(){return this.m_ratio},initialize:function(n){var r,t,i,u;this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=n.type;this.m_prev=null;this.m_next=null;this.m_body1=n.body1;this.m_body2=n.body2;this.m_collideConnected=n.collideConnected;this.m_islandFlag=!1;this.m_userData=n.userData;this.m_groundAnchor1=new b2Vec2;this.m_groundAnchor2=new b2Vec2;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_u1=new b2Vec2;this.m_u2=new b2Vec2;this.m_ground=this.m_body1.m_world.m_groundBody;this.m_groundAnchor1.x=n.groundPoint1.x-this.m_ground.m_position.x;this.m_groundAnchor1.y=n.groundPoint1.y-this.m_ground.m_position.y;this.m_groundAnchor2.x=n.groundPoint2.x-this.m_ground.m_position.x;this.m_groundAnchor2.y=n.groundPoint2.y-this.m_ground.m_position.y;r=this.m_body1.m_R;t=n.anchorPoint1.x-this.m_body1.m_position.x;i=n.anchorPoint1.y-this.m_body1.m_position.y;this.m_localAnchor1.x=t*r.col1.x+i*r.col1.y;this.m_localAnchor1.y=t*r.col2.x+i*r.col2.y;r=this.m_body2.m_R;t=n.anchorPoint2.x-this.m_body2.m_position.x;i=n.anchorPoint2.y-this.m_body2.m_position.y;this.m_localAnchor2.x=t*r.col1.x+i*r.col1.y;this.m_localAnchor2.y=t*r.col2.x+i*r.col2.y;this.m_ratio=n.ratio;t=n.groundPoint1.x-n.anchorPoint1.x;i=n.groundPoint1.y-n.anchorPoint1.y;u=Math.sqrt(t*t+i*i);t=n.groundPoint2.x-n.anchorPoint2.x;i=n.groundPoint2.y-n.anchorPoint2.y;var o=Math.sqrt(t*t+i*i),f=b2Math.b2Max(.5*b2PulleyJoint.b2_minPulleyLength,u),e=b2Math.b2Max(.5*b2PulleyJoint.b2_minPulleyLength,o);this.m_constant=f+this.m_ratio*e;this.m_maxLength1=b2Math.b2Clamp(n.maxLength1,f,this.m_constant-this.m_ratio*b2PulleyJoint.b2_minPulleyLength);this.m_maxLength2=b2Math.b2Clamp(n.maxLength2,e,(this.m_constant-b2PulleyJoint.b2_minPulleyLength)/this.m_ratio);this.m_pulleyImpulse=0;this.m_limitImpulse1=0;this.m_limitImpulse2=0},PrepareVelocitySolver:function(){var n=this.m_body1,t=this.m_body2,i,r,u,f,e,h,c;i=n.m_R;r=i.col1.x*this.m_localAnchor1.x+i.col2.x*this.m_localAnchor1.y;u=i.col1.y*this.m_localAnchor1.x+i.col2.y*this.m_localAnchor1.y;i=t.m_R;var o=i.col1.x*this.m_localAnchor2.x+i.col2.x*this.m_localAnchor2.y,s=i.col1.y*this.m_localAnchor2.x+i.col2.y*this.m_localAnchor2.y,p=n.m_position.x+r,w=n.m_position.y+u,b=t.m_position.x+o,k=t.m_position.y+s,d=this.m_ground.m_position.x+this.m_groundAnchor1.x,g=this.m_ground.m_position.y+this.m_groundAnchor1.y,nt=this.m_ground.m_position.x+this.m_groundAnchor2.x,tt=this.m_ground.m_position.y+this.m_groundAnchor2.y;this.m_u1.Set(p-d,w-g);this.m_u2.Set(b-nt,k-tt);f=this.m_u1.Length();e=this.m_u2.Length();f>b2Settings.b2_linearSlop?this.m_u1.Multiply(1/f):this.m_u1.SetZero();e>b2Settings.b2_linearSlop?this.m_u2.Multiply(1/e):this.m_u2.SetZero();f<this.m_maxLength1?(this.m_limitState1=b2Joint.e_inactiveLimit,this.m_limitImpulse1=0):(this.m_limitState1=b2Joint.e_atUpperLimit,this.m_limitPositionImpulse1=0);e<this.m_maxLength2?(this.m_limitState2=b2Joint.e_inactiveLimit,this.m_limitImpulse2=0):(this.m_limitState2=b2Joint.e_atUpperLimit,this.m_limitPositionImpulse2=0);h=r*this.m_u1.y-u*this.m_u1.x;c=o*this.m_u2.y-s*this.m_u2.x;this.m_limitMass1=n.m_invMass+n.m_invI*h*h;this.m_limitMass2=t.m_invMass+t.m_invI*c*c;this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2;this.m_limitMass1=1/this.m_limitMass1;this.m_limitMass2=1/this.m_limitMass2;this.m_pulleyMass=1/this.m_pulleyMass;var l=(-this.m_pulleyImpulse-this.m_limitImpulse1)*this.m_u1.x,a=(-this.m_pulleyImpulse-this.m_limitImpulse1)*this.m_u1.y,v=(-this.m_ratio*this.m_pulleyImpulse-this.m_limitImpulse2)*this.m_u2.x,y=(-this.m_ratio*this.m_pulleyImpulse-this.m_limitImpulse2)*this.m_u2.y;n.m_linearVelocity.x+=n.m_invMass*l;n.m_linearVelocity.y+=n.m_invMass*a;n.m_angularVelocity+=n.m_invI*(r*a-u*l);t.m_linearVelocity.x+=t.m_invMass*v;t.m_linearVelocity.y+=t.m_invMass*y;t.m_angularVelocity+=t.m_invI*(o*y-s*v)},SolveVelocityConstraints:function(){var n=this.m_body1,t=this.m_body2,r,h,c,l,a,v,y,p,w,u,f,e,o,s,i,b;r=n.m_R;h=r.col1.x*this.m_localAnchor1.x+r.col2.x*this.m_localAnchor1.y;c=r.col1.y*this.m_localAnchor1.x+r.col2.y*this.m_localAnchor1.y;r=t.m_R;l=r.col1.x*this.m_localAnchor2.x+r.col2.x*this.m_localAnchor2.y;a=r.col1.y*this.m_localAnchor2.x+r.col2.y*this.m_localAnchor2.y;v=n.m_linearVelocity.x+-n.m_angularVelocity*c;y=n.m_linearVelocity.y+n.m_angularVelocity*h;p=t.m_linearVelocity.x+-t.m_angularVelocity*a;w=t.m_linearVelocity.y+t.m_angularVelocity*l;s=-(this.m_u1.x*v+this.m_u1.y*y)-this.m_ratio*(this.m_u2.x*p+this.m_u2.y*w);i=-this.m_pulleyMass*s;this.m_pulleyImpulse+=i;u=-i*this.m_u1.x;f=-i*this.m_u1.y;e=-this.m_ratio*i*this.m_u2.x;o=-this.m_ratio*i*this.m_u2.y;n.m_linearVelocity.x+=n.m_invMass*u;n.m_linearVelocity.y+=n.m_invMass*f;n.m_angularVelocity+=n.m_invI*(h*f-c*u);t.m_linearVelocity.x+=t.m_invMass*e;t.m_linearVelocity.y+=t.m_invMass*o;t.m_angularVelocity+=t.m_invI*(l*o-a*e);this.m_limitState1==b2Joint.e_atUpperLimit&&(v=n.m_linearVelocity.x+-n.m_angularVelocity*c,y=n.m_linearVelocity.y+n.m_angularVelocity*h,s=-(this.m_u1.x*v+this.m_u1.y*y),i=-this.m_limitMass1*s,b=this.m_limitImpulse1,this.m_limitImpulse1=b2Math.b2Max(0,this.m_limitImpulse1+i),i=this.m_limitImpulse1-b,u=-i*this.m_u1.x,f=-i*this.m_u1.y,n.m_linearVelocity.x+=n.m_invMass*u,n.m_linearVelocity.y+=n.m_invMass*f,n.m_angularVelocity+=n.m_invI*(h*f-c*u));this.m_limitState2==b2Joint.e_atUpperLimit&&(p=t.m_linearVelocity.x+-t.m_angularVelocity*a,w=t.m_linearVelocity.y+t.m_angularVelocity*l,s=-(this.m_u2.x*p+this.m_u2.y*w),i=-this.m_limitMass2*s,b=this.m_limitImpulse2,this.m_limitImpulse2=b2Math.b2Max(0,this.m_limitImpulse2+i),i=this.m_limitImpulse2-b,e=-i*this.m_u2.x,o=-i*this.m_u2.y,t.m_linearVelocity.x+=t.m_invMass*e,t.m_linearVelocity.y+=t.m_invMass*o,t.m_angularVelocity+=t.m_invI*(l*o-a*e))},SolvePositionConstraints:function(){var n=this.m_body1,t=this.m_body2,i,b=this.m_ground.m_position.x+this.m_groundAnchor1.x,k=this.m_ground.m_position.y+this.m_groundAnchor1.y,d=this.m_ground.m_position.x+this.m_groundAnchor2.x,g=this.m_ground.m_position.y+this.m_groundAnchor2.y,a,v,y,p,f,e,o,s,h,c,r,u,w,l=0;return i=n.m_R,a=i.col1.x*this.m_localAnchor1.x+i.col2.x*this.m_localAnchor1.y,v=i.col1.y*this.m_localAnchor1.x+i.col2.y*this.m_localAnchor1.y,i=t.m_R,y=i.col1.x*this.m_localAnchor2.x+i.col2.x*this.m_localAnchor2.y,p=i.col1.y*this.m_localAnchor2.x+i.col2.y*this.m_localAnchor2.y,f=n.m_position.x+a,e=n.m_position.y+v,o=t.m_position.x+y,s=t.m_position.y+p,this.m_u1.Set(f-b,e-k),this.m_u2.Set(o-d,s-g),h=this.m_u1.Length(),c=this.m_u2.Length(),h>b2Settings.b2_linearSlop?this.m_u1.Multiply(1/h):this.m_u1.SetZero(),c>b2Settings.b2_linearSlop?this.m_u2.Multiply(1/c):this.m_u2.SetZero(),r=this.m_constant-h-this.m_ratio*c,l=b2Math.b2Max(l,Math.abs(r)),r=b2Math.b2Clamp(r,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection),u=-this.m_pulleyMass*r,f=-u*this.m_u1.x,e=-u*this.m_u1.y,o=-this.m_ratio*u*this.m_u2.x,s=-this.m_ratio*u*this.m_u2.y,n.m_position.x+=n.m_invMass*f,n.m_position.y+=n.m_invMass*e,n.m_rotation+=n.m_invI*(a*e-v*f),t.m_position.x+=t.m_invMass*o,t.m_position.y+=t.m_invMass*s,t.m_rotation+=t.m_invI*(y*s-p*o),n.m_R.Set(n.m_rotation),t.m_R.Set(t.m_rotation),this.m_limitState1==b2Joint.e_atUpperLimit&&(i=n.m_R,a=i.col1.x*this.m_localAnchor1.x+i.col2.x*this.m_localAnchor1.y,v=i.col1.y*this.m_localAnchor1.x+i.col2.y*this.m_localAnchor1.y,f=n.m_position.x+a,e=n.m_position.y+v,this.m_u1.Set(f-b,e-k),h=this.m_u1.Length(),h>b2Settings.b2_linearSlop?(this.m_u1.x*=1/h,this.m_u1.y*=1/h):this.m_u1.SetZero(),r=this.m_maxLength1-h,l=b2Math.b2Max(l,-r),r=b2Math.b2Clamp(r+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),u=-this.m_limitMass1*r,w=this.m_limitPositionImpulse1,this.m_limitPositionImpulse1=b2Math.b2Max(0,this.m_limitPositionImpulse1+u),u=this.m_limitPositionImpulse1-w,f=-u*this.m_u1.x,e=-u*this.m_u1.y,n.m_position.x+=n.m_invMass*f,n.m_position.y+=n.m_invMass*e,n.m_rotation+=n.m_invI*(a*e-v*f),n.m_R.Set(n.m_rotation)),this.m_limitState2==b2Joint.e_atUpperLimit&&(i=t.m_R,y=i.col1.x*this.m_localAnchor2.x+i.col2.x*this.m_localAnchor2.y,p=i.col1.y*this.m_localAnchor2.x+i.col2.y*this.m_localAnchor2.y,o=t.m_position.x+y,s=t.m_position.y+p,this.m_u2.Set(o-d,s-g),c=this.m_u2.Length(),c>b2Settings.b2_linearSlop?(this.m_u2.x*=1/c,this.m_u2.y*=1/c):this.m_u2.SetZero(),r=this.m_maxLength2-c,l=b2Math.b2Max(l,-r),r=b2Math.b2Clamp(r+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),u=-this.m_limitMass2*r,w=this.m_limitPositionImpulse2,this.m_limitPositionImpulse2=b2Math.b2Max(0,this.m_limitPositionImpulse2+u),u=this.m_limitPositionImpulse2-w,o=-u*this.m_u2.x,s=-u*this.m_u2.y,t.m_position.x+=t.m_invMass*o,t.m_position.y+=t.m_invMass*s,t.m_rotation+=t.m_invI*(y*s-p*o),t.m_R.Set(t.m_rotation)),l<b2Settings.b2_linearSlop},m_ground:null,m_groundAnchor1:new b2Vec2,m_groundAnchor2:new b2Vec2,m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_u1:new b2Vec2,m_u2:new b2Vec2,m_constant:null,m_ratio:null,m_maxLength1:null,m_maxLength2:null,m_pulleyMass:null,m_limitMass1:null,m_limitMass2:null,m_pulleyImpulse:null,m_limitImpulse1:null,m_limitImpulse2:null,m_limitPositionImpulse1:null,m_limitPositionImpulse2:null,m_limitState1:0,m_limitState2:0});b2PulleyJoint.b2_minPulleyLength=b2Settings.b2_lengthUnitsPerMeter;b2PulleyJointDef=Class.create();Object.extend(b2PulleyJointDef.prototype,b2JointDef.prototype);Object.extend(b2PulleyJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=!1;this.groundPoint1=new b2Vec2;this.groundPoint2=new b2Vec2;this.anchorPoint1=new b2Vec2;this.anchorPoint2=new b2Vec2;this.type=b2Joint.e_pulleyJoint;this.groundPoint1.Set(-1,1);this.groundPoint2.Set(1,1);this.anchorPoint1.Set(-1,0);this.anchorPoint2.Set(1,0);this.maxLength1=.5*b2PulleyJoint.b2_minPulleyLength;this.maxLength2=.5*b2PulleyJoint.b2_minPulleyLength;this.ratio=1;this.collideConnected=!0},groundPoint1:new b2Vec2,groundPoint2:new b2Vec2,anchorPoint1:new b2Vec2,anchorPoint2:new b2Vec2,maxLength1:null,maxLength2:null,ratio:null});b2RevoluteJoint=Class.create();Object.extend(b2RevoluteJoint.prototype,b2Joint.prototype);Object.extend(b2RevoluteJoint.prototype,{GetAnchor1:function(){var n=this.m_body1.m_R;return new b2Vec2(this.m_body1.m_position.x+(n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y),this.m_body1.m_position.y+(n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y))},GetAnchor2:function(){var n=this.m_body2.m_R;return new b2Vec2(this.m_body2.m_position.x+(n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y),this.m_body2.m_position.y+(n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y))},GetJointAngle:function(){return this.m_body2.m_rotation-this.m_body1.m_rotation},GetJointSpeed:function(){return this.m_body2.m_angularVelocity-this.m_body1.m_angularVelocity},GetMotorTorque:function(n){return n*this.m_motorImpulse},SetMotorSpeed:function(n){this.m_motorSpeed=n},SetMotorTorque:function(n){this.m_maxMotorTorque=n},GetReactionForce:function(n){var t=this.m_ptpImpulse.Copy();return t.Multiply(n),t},GetReactionTorque:function(n){return n*this.m_limitImpulse},initialize:function(n){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=n.type;this.m_prev=null;this.m_next=null;this.m_body1=n.body1;this.m_body2=n.body2;this.m_collideConnected=n.collideConnected;this.m_islandFlag=!1;this.m_userData=n.userData;this.K=new b2Mat22;this.K1=new b2Mat22;this.K2=new b2Mat22;this.K3=new b2Mat22;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_ptpImpulse=new b2Vec2;this.m_ptpMass=new b2Mat22;var t,i,r;t=this.m_body1.m_R;i=n.anchorPoint.x-this.m_body1.m_position.x;r=n.anchorPoint.y-this.m_body1.m_position.y;this.m_localAnchor1.x=i*t.col1.x+r*t.col1.y;this.m_localAnchor1.y=i*t.col2.x+r*t.col2.y;t=this.m_body2.m_R;i=n.anchorPoint.x-this.m_body2.m_position.x;r=n.anchorPoint.y-this.m_body2.m_position.y;this.m_localAnchor2.x=i*t.col1.x+r*t.col1.y;this.m_localAnchor2.y=i*t.col2.x+r*t.col2.y;this.m_intialAngle=this.m_body2.m_rotation-this.m_body1.m_rotation;this.m_ptpImpulse.Set(0,0);this.m_motorImpulse=0;this.m_limitImpulse=0;this.m_limitPositionImpulse=0;this.m_lowerAngle=n.lowerAngle;this.m_upperAngle=n.upperAngle;this.m_maxMotorTorque=n.motorTorque;this.m_motorSpeed=n.motorSpeed;this.m_enableLimit=n.enableLimit;this.m_enableMotor=n.enableMotor},K:new b2Mat22,K1:new b2Mat22,K2:new b2Mat22,K3:new b2Mat22,PrepareVelocitySolver:function(){var t=this.m_body1,i=this.m_body2,n,r,u,l;n=t.m_R;r=n.col1.x*this.m_localAnchor1.x+n.col2.x*this.m_localAnchor1.y;u=n.col1.y*this.m_localAnchor1.x+n.col2.y*this.m_localAnchor1.y;n=i.m_R;var o=n.col1.x*this.m_localAnchor2.x+n.col2.x*this.m_localAnchor2.y,s=n.col1.y*this.m_localAnchor2.x+n.col2.y*this.m_localAnchor2.y,h=t.m_invMass,c=i.m_invMass,f=t.m_invI,e=i.m_invI;this.K1.col1.x=h+c;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=h+c;this.K2.col1.x=f*u*u;this.K2.col2.x=-f*r*u;this.K2.col1.y=-f*r*u;this.K2.col2.y=f*r*r;this.K3.col1.x=e*s*s;this.K3.col2.x=-e*o*s;this.K3.col1.y=-e*o*s;this.K3.col2.y=e*o*o;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.AddM(this.K3);this.K.Invert(this.m_ptpMass);this.m_motorMass=1/(f+e);this.m_enableMotor==!1&&(this.m_motorImpulse=0);this.m_enableLimit?(l=i.m_rotation-t.m_rotation-this.m_intialAngle,b2Math.b2Abs(this.m_upperAngle-this.m_lowerAngle)<2*b2Settings.b2_angularSlop?this.m_limitState=b2Joint.e_equalLimits:l<=this.m_lowerAngle?(this.m_limitState!=b2Joint.e_atLowerLimit&&(this.m_limitImpulse=0),this.m_limitState=b2Joint.e_atLowerLimit):l>=this.m_upperAngle?(this.m_limitState!=b2Joint.e_atUpperLimit&&(this.m_limitImpulse=0),this.m_limitState=b2Joint.e_atUpperLimit):(this.m_limitState=b2Joint.e_inactiveLimit,this.m_limitImpulse=0)):this.m_limitImpulse=0;b2World.s_enableWarmStarting?(t.m_linearVelocity.x-=h*this.m_ptpImpulse.x,t.m_linearVelocity.y-=h*this.m_ptpImpulse.y,t.m_angularVelocity-=f*(r*this.m_ptpImpulse.y-u*this.m_ptpImpulse.x+this.m_motorImpulse+this.m_limitImpulse),i.m_linearVelocity.x+=c*this.m_ptpImpulse.x,i.m_linearVelocity.y+=c*this.m_ptpImpulse.y,i.m_angularVelocity+=e*(o*this.m_ptpImpulse.y-s*this.m_ptpImpulse.x+this.m_motorImpulse+this.m_limitImpulse)):(this.m_ptpImpulse.SetZero(),this.m_motorImpulse=0,this.m_limitImpulse=0);this.m_limitPositionImpulse=0},SolveVelocityConstraints:function(n){var t=this.m_body1,i=this.m_body2,r,h,c,p,u;r=t.m_R;h=r.col1.x*this.m_localAnchor1.x+r.col2.x*this.m_localAnchor1.y;c=r.col1.y*this.m_localAnchor1.x+r.col2.y*this.m_localAnchor1.y;r=i.m_R;var l=r.col1.x*this.m_localAnchor2.x+r.col2.x*this.m_localAnchor2.y,a=r.col1.y*this.m_localAnchor2.x+r.col2.y*this.m_localAnchor2.y,o,v=i.m_linearVelocity.x+-i.m_angularVelocity*a-t.m_linearVelocity.x- -t.m_angularVelocity*c,y=i.m_linearVelocity.y+i.m_angularVelocity*l-t.m_linearVelocity.y-t.m_angularVelocity*h,f=-(this.m_ptpMass.col1.x*v+this.m_ptpMass.col2.x*y),e=-(this.m_ptpMass.col1.y*v+this.m_ptpMass.col2.y*y);if(this.m_ptpImpulse.x+=f,this.m_ptpImpulse.y+=e,t.m_linearVelocity.x-=t.m_invMass*f,t.m_linearVelocity.y-=t.m_invMass*e,t.m_angularVelocity-=t.m_invI*(h*e-c*f),i.m_linearVelocity.x+=i.m_invMass*f,i.m_linearVelocity.y+=i.m_invMass*e,i.m_angularVelocity+=i.m_invI*(l*e-a*f),this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){var w=i.m_angularVelocity-t.m_angularVelocity-this.m_motorSpeed,s=-this.m_motorMass*w,b=this.m_motorImpulse;this.m_motorImpulse=b2Math.b2Clamp(this.m_motorImpulse+s,-n.dt*this.m_maxMotorTorque,n.dt*this.m_maxMotorTorque);s=this.m_motorImpulse-b;t.m_angularVelocity-=t.m_invI*s;i.m_angularVelocity+=i.m_invI*s}this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit&&(p=i.m_angularVelocity-t.m_angularVelocity,u=-this.m_motorMass*p,this.m_limitState==b2Joint.e_equalLimits?this.m_limitImpulse+=u:this.m_limitState==b2Joint.e_atLowerLimit?(o=this.m_limitImpulse,this.m_limitImpulse=b2Math.b2Max(this.m_limitImpulse+u,0),u=this.m_limitImpulse-o):this.m_limitState==b2Joint.e_atUpperLimit&&(o=this.m_limitImpulse,this.m_limitImpulse=b2Math.b2Min(this.m_limitImpulse+u,0),u=this.m_limitImpulse-o),t.m_angularVelocity-=t.m_invI*u,i.m_angularVelocity+=i.m_invI*u)},SolvePositionConstraints:function(){var a,i,n=this.m_body1,t=this.m_body2,k=0,r,f,e,h,c,l,p,u;r=n.m_R;f=r.col1.x*this.m_localAnchor1.x+r.col2.x*this.m_localAnchor1.y;e=r.col1.y*this.m_localAnchor1.x+r.col2.y*this.m_localAnchor1.y;r=t.m_R;var o=r.col1.x*this.m_localAnchor2.x+r.col2.x*this.m_localAnchor2.y,s=r.col1.y*this.m_localAnchor2.x+r.col2.y*this.m_localAnchor2.y,nt=n.m_position.x+f,tt=n.m_position.y+e,it=t.m_position.x+o,rt=t.m_position.y+s,w=it-nt,b=rt-tt;k=Math.sqrt(w*w+b*b);var d=n.m_invMass,g=t.m_invMass,v=n.m_invI,y=t.m_invI;return this.K1.col1.x=d+g,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=d+g,this.K2.col1.x=v*e*e,this.K2.col2.x=-v*f*e,this.K2.col1.y=-v*f*e,this.K2.col2.y=v*f*f,this.K3.col1.x=y*s*s,this.K3.col2.x=-y*o*s,this.K3.col1.y=-y*o*s,this.K3.col2.y=y*o*o,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.AddM(this.K3),this.K.Solve(b2RevoluteJoint.tImpulse,-w,-b),h=b2RevoluteJoint.tImpulse.x,c=b2RevoluteJoint.tImpulse.y,n.m_position.x-=n.m_invMass*h,n.m_position.y-=n.m_invMass*c,n.m_rotation-=n.m_invI*(f*c-e*h),n.m_R.Set(n.m_rotation),t.m_position.x+=t.m_invMass*h,t.m_position.y+=t.m_invMass*c,t.m_rotation+=t.m_invI*(o*c-s*h),t.m_R.Set(t.m_rotation),l=0,this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit&&(p=t.m_rotation-n.m_rotation-this.m_intialAngle,u=0,this.m_limitState==b2Joint.e_equalLimits?(i=b2Math.b2Clamp(p,-b2Settings.b2_maxAngularCorrection,b2Settings.b2_maxAngularCorrection),u=-this.m_motorMass*i,l=b2Math.b2Abs(i)):this.m_limitState==b2Joint.e_atLowerLimit?(i=p-this.m_lowerAngle,l=b2Math.b2Max(0,-i),i=b2Math.b2Clamp(i+b2Settings.b2_angularSlop,-b2Settings.b2_maxAngularCorrection,0),u=-this.m_motorMass*i,a=this.m_limitPositionImpulse,this.m_limitPositionImpulse=b2Math.b2Max(this.m_limitPositionImpulse+u,0),u=this.m_limitPositionImpulse-a):this.m_limitState==b2Joint.e_atUpperLimit&&(i=p-this.m_upperAngle,l=b2Math.b2Max(0,i),i=b2Math.b2Clamp(i-b2Settings.b2_angularSlop,0,b2Settings.b2_maxAngularCorrection),u=-this.m_motorMass*i,a=this.m_limitPositionImpulse,this.m_limitPositionImpulse=b2Math.b2Min(this.m_limitPositionImpulse+u,0),u=this.m_limitPositionImpulse-a),n.m_rotation-=n.m_invI*u,n.m_R.Set(n.m_rotation),t.m_rotation+=t.m_invI*u,t.m_R.Set(t.m_rotation)),k<=b2Settings.b2_linearSlop&&l<=b2Settings.b2_angularSlop},m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_ptpImpulse:new b2Vec2,m_motorImpulse:null,m_limitImpulse:null,m_limitPositionImpulse:null,m_ptpMass:new b2Mat22,m_motorMass:null,m_intialAngle:null,m_lowerAngle:null,m_upperAngle:null,m_maxMotorTorque:null,m_motorSpeed:null,m_enableLimit:null,m_enableMotor:null,m_limitState:0});b2RevoluteJoint.tImpulse=new b2Vec2;b2RevoluteJointDef=Class.create();Object.extend(b2RevoluteJointDef.prototype,b2JointDef.prototype);Object.extend(b2RevoluteJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=!1;this.type=b2Joint.e_revoluteJoint;this.anchorPoint=new b2Vec2(0,0);this.lowerAngle=0;this.upperAngle=0;this.motorTorque=0;this.motorSpeed=0;this.enableLimit=!1;this.enableMotor=!1},anchorPoint:null,lowerAngle:null,upperAngle:null,motorTorque:null,motorSpeed:null,enableLimit:null,enableMotor:null});demos={};demos.InitWorlds=[];demos.top={};demos.top.createBall=function(n,t,i,r,u){var f=new b2CircleDef,e;return u||(f.density=1),f.radius=r||10,f.restitution=.2,f.friction=9999999,e=new b2BodyDef,e.AddShape(f),e.position.Set(t,i),n.CreateBody(e)};demos.top.createPoly=function(n,t,i,r,u){var e=new b2PolyDef,f,o;for(u||(e.density=1),e.vertexCount=r.length,f=0;f<r.length;f++)e.vertices[f].Set(r[f][0],r[f][1]);return o=new b2BodyDef,o.AddShape(e),o.position.Set(t,i),n.CreateBody(o)};demos.top.createRotation=function(n,t,i,r){var u=new b2RevoluteJointDef;u.anchorPoint.Set(t,i);u.body1=world.m_groundBody;u.body2=n;u.motorSpeed=r;u.motorTorque=5e12;u.enableMotor=!0;world.CreateJoint(u)};demos.top.initWorld=function(n){var r=30,i=.4*Math.PI,o=223,s=460,h=163,c=440,l=103,a=420,v=43,y=400,g=demos.top.createBall(n,v,y,r,!1),nt=demos.top.createBall(n,l,a,r,!1),tt=demos.top.createBall(n,h,c,r,!1),it=demos.top.createBall(n,o,s,r,!1),f,d,t;demos.top.createRotation(g,v,y,-i);demos.top.createRotation(it,o,s,-i);demos.top.createRotation(tt,h,c,-i);demos.top.createRotation(nt,l,a,-i);var p=400,w=330,rt=demos.top.createPoly(n,p,w,[[0,0],[100,30],[-100,30]]),u=new b2RevoluteJointDef;u.body1=rt;u.body2=n.GetGroundBody();u.anchorPoint=new b2Vec2(p,w);n.CreateJoint(u);f=new b2BoxDef;f.extents.Set(5,80);f.density=1;var b=710,k=410,e=new b2BodyDef;e.AddShape(f);e.position.Set(b,k);d=n.CreateBody(e);t=new b2RevoluteJointDef;t.anchorPoint.Set(b,k);t.body1=n.m_groundBody;t.body2=d;t.motorSpeed=i*4;t.motorTorque=5e12;t.enableMotor=!0;n.CreateJoint(t)};demos.InitWorlds.push(demos.top.initWorld);demos.stack={};demos.stack.initWorld=function(n){var r=new b2BoxDef,i=new b2BodyDef,t;for(i.AddShape(r),r.density=1,r.friction=.5,r.extents.Set(10,10),t=0;t<8;t++)i.position.Set(249-Math.random()*2,245-t*22),n.CreateBody(i);for(t=0;t<8;t++)i.position.Set(150-Math.random()*5+t,245-t*22),n.CreateBody(i);for(t=0;t<8;t++)i.position.Set(350+Math.random()*5-t,245-t*22),n.CreateBody(i)};demos.InitWorlds.push(demos.stack.initWorld);demos.pendulum={};demos.pendulum.initWorld=function(n){for(var u=n.GetGroundBody(),t=new b2RevoluteJointDef,r=150,i=0;i<4;i++)t.anchorPoint.Set(250+40*i,200-r),t.body1=u,t.body2=createBall(n,250+40*i,200,20,1,.1),n.CreateJoint(t);t.anchorPoint.Set(210,200-r);t.body1=u;t.body2=createBall(n,210-r,200-r,20,1,.1);n.CreateJoint(t)};demos.InitWorlds.push(demos.pendulum.initWorld);demos.crank={};demos.crank.initWorld=function(n){var a,e,t,o,v,s,i,h,y,c,r,l,u,f;let p=68,w=415;var ot=n.m_groundBody,tt=ot,it=new b2BoxDef;it.extents.Set(5,25);it.density=1;a=new b2BodyDef;a.AddShape(it);a.position.Set(p,w);e=n.CreateBody(a);t=new b2RevoluteJointDef;t.anchorPoint.Set(p,w+25);t.body1=tt;t.body2=e;t.motorSpeed=-1*Math.PI;t.motorTorque=9e8;t.enableMotor=!0;n.CreateJoint(t);tt=e;it.extents.Set(5,45);a.position.Set(p,w-70);e=n.CreateBody(a);t.anchorPoint.Set(p,w-25);t.body1=tt;t.body2=e;t.enableMotor=!1;n.CreateJoint(t);tt=e;it.extents.Set(50,10);a.position.Set(p,w-115);e=n.CreateBody(a);t.anchorPoint.Set(p,w-115);t.body1=tt;t.body2=e;n.CreateJoint(t);o=new b2PrismaticJointDef;o.anchorPoint.Set(p,w-115);o.body1=ot;o.body2=e;o.axis.Set(0,1);o.motorSpeed=0;o.motorForce=1e5;o.enableMotor=!0;n.CreateJoint(o);let b=720,k=435,nt=25,st=5;var ht=n.m_groundBody,rt=ht,ut=new b2BoxDef;ut.extents.Set(nt,st);ut.density=1;v=new b2BodyDef;v.AddShape(ut);v.position.Set(b,k);s=n.CreateBody(v);i=new b2RevoluteJointDef;i.anchorPoint.Set(b+nt,k);i.body1=rt;i.body2=s;i.motorSpeed=-1*Math.PI;i.motorTorque=9e8;i.enableMotor=!1;n.CreateJoint(i);rt=s;ut.extents.Set(nt+20,st);v.position.Set(b-70,k);s=n.CreateBody(v);i.anchorPoint.Set(b-25,k);i.body1=rt;i.body2=s;i.enableMotor=!0;n.CreateJoint(i);rt=s;ut.extents.Set(10,50);v.position.Set(b-115,k);s=n.CreateBody(v);i.anchorPoint.Set(b-115,k);i.body1=rt;i.body2=s;n.CreateJoint(i);h=new b2PrismaticJointDef;h.anchorPoint.Set(b-115,k);h.body1=ot;h.body2=s;h.axis.Set(-1,0);h.motorSpeed=0;h.motorForce=1e5;h.enableMotor=!0;n.CreateJoint(h);let d=200,g=435;var ct=n.m_groundBody,ft=ct,et=new b2BoxDef;et.extents.Set(nt,st);et.density=1;y=new b2BodyDef;y.AddShape(et);y.position.Set(d,g);c=n.CreateBody(y);r=new b2RevoluteJointDef;r.anchorPoint.Set(d-nt,g);r.body1=ft;r.body2=c;r.motorSpeed=-1*Math.PI;r.motorTorque=9e8;r.enableMotor=!1;n.CreateJoint(r);ft=c;et.extents.Set(nt+20,st);y.position.Set(d+70,g);c=n.CreateBody(y);r.anchorPoint.Set(d+25,g);r.body1=ft;r.body2=c;r.enableMotor=!0;n.CreateJoint(r);ft=c;et.extents.Set(10,50);y.position.Set(d+115,g);c=n.CreateBody(y);r.anchorPoint.Set(d+115,g);r.body1=ft;r.body2=c;n.CreateJoint(r);l=new b2PrismaticJointDef;l.anchorPoint.Set(d+115,g);l.body1=ot;l.body2=c;l.axis.Set(1,0);l.motorSpeed=0;l.motorForce=1e5;l.enableMotor=!0;n.CreateJoint(l);u=new b2BoxDef;u.extents.Set(95,2);u.density=0;f=new b2BodyDef;f.AddShape(u);f.position.Set(692,380);n.CreateBody(f);u=new b2BoxDef;u.extents.Set(95,2);u.density=0;f=new b2BodyDef;f.AddShape(u);f.position.Set(232,380);n.CreateBody(f);u=new b2BoxDef;u.extents.Set(2,95);u.density=0;f=new b2BodyDef;f.AddShape(u);f.position.Set(128,380);n.CreateBody(f)};demos.InitWorlds.push(demos.crank.initWorld);initId=0;world=createWorld(),function(){InitializeBox2D()}();